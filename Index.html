<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡πÄ‡∏õ‡πà‡∏≤‡∏â‡∏∏‡∏ö by rs</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@200;400;600;800&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Kanit', 'sans-serif'], display: ['Orbitron', 'sans-serif'] },
                    colors: { 
                        rs: { bg: '#090014', card: '#1a0b2e', primary: '#d946ef', secondary: '#8b5cf6', accent: '#22d3ee' } 
                    },
                    animation: {
                        'neon-pulse': 'neonPulse 2s infinite alternate',
                        'hand-shake': 'handShake 0.5s ease-in-out infinite'
                    },
                    keyframes: {
                        neonPulse: { '0%': { textShadow: '0 0 10px #d946ef, 0 0 20px #d946ef' }, '100%': { textShadow: '0 0 20px #8b5cf6, 0 0 40px #8b5cf6' } },
                        handShake: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-20px)' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* BASE STYLES */
        body { background-color: #090014; color: #fff; overflow-x: hidden; }
        
        /* DYNAMIC BG */
        .bg-grid {
            position: fixed; inset: 0; z-index: -1;
            background-image: linear-gradient(rgba(217, 70, 239, 0.05) 1px, transparent 1px),
            linear-gradient(90deg, rgba(217, 70, 239, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
        }
        
        /* UI COMPONENTS */
        .glass-panel {
            background: rgba(26, 11, 46, 0.7);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(217, 70, 239, 0.1);
            border-radius: 24px;
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.1);
        }
        
        .btn-rs {
            background: linear-gradient(135deg, #c026d3, #7c3aed);
            color: white; font-weight: 800; border-radius: 12px;
            transition: 0.3s; position: relative; overflow: hidden;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-rs:hover { transform: translateY(-2px); box-shadow: 0 0 20px rgba(217, 70, 239, 0.6); }
        .btn-rs:active { transform: scale(0.95); }

        .input-rs {
            width: 100%; background: rgba(0,0,0,0.4); border: 1px solid #4c1d95;
            padding: 14px; border-radius: 12px; color: white; outline: none; transition: 0.3s;
        }
        .input-rs:focus { border-color: #d946ef; box-shadow: 0 0 10px rgba(217, 70, 239, 0.3); }

        /* GAME SPECIFIC */
        .hand-container { width: 120px; height: 120px; display: flex; align-items: center; justify-content: center; font-size: 5rem; transition: 0.3s; }
        .hand-container.shaking { animation: handShake 0.4s infinite; }
        
        .rps-choice {
            width: 80px; height: 80px; border-radius: 50%;
            background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; cursor: pointer; transition: 0.3s;
        }
        .rps-choice:hover { transform: scale(1.1); background: rgba(255,255,255,0.1); }
        .rps-choice.selected {
            border-color: #d946ef; background: rgba(217, 70, 239, 0.2);
            box-shadow: 0 0 20px rgba(217, 70, 239, 0.4); transform: scale(1.1);
        }

        /* OVERLAYS */
        .full-page { position: fixed; inset: 0; background: #090014; z-index: 50; display: none; flex-direction: column; overflow-y: auto; }
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* CHAT */
        .chat-bubble { padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; margin-bottom: 6px; max-width: 80%; word-wrap: break-word; }
        .chat-me { background: #7c3aed; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-other { background: #334155; color: white; align-self: flex-start; border-bottom-left-radius: 2px; }
    </style>
</head>
<body class="antialiased">

    <div class="bg-grid"></div>

    <div id="view-auth" class="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-[#090014]">
        <div class="w-full max-w-sm glass-panel p-8 text-center animate__animated animate__zoomIn">
            <div class="mb-8">
                <h1 class="text-5xl font-black font-display text-transparent bg-clip-text bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-500 animate-neon-pulse mb-2">‡πÄ‡∏õ‡πà‡∏≤‡∏â‡∏∏‡∏ö</h1>
                <div class="text-xl font-display text-slate-400 tracking-[0.5em]">BY RS</div>
            </div>

            <div id="login-form" class="space-y-4">
                <input id="l-email" class="input-rs text-center" placeholder="Email Address">
                <input id="l-pass" type="password" class="input-rs text-center" placeholder="Password">
                <button onclick="Auth.login()" class="btn-rs w-full py-4 text-lg mt-4 shadow-lg">START GAME</button>
                <div class="mt-4 text-sm text-slate-400">
                    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏≠‡∏î‡∏µ? <button onclick="UI.toggleAuth('reg')" class="text-pink-400 font-bold hover:underline">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                </div>
            </div>

            <div id="reg-form" class="space-y-4 hidden">
                <input id="r-nick" class="input-rs text-center" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡πÄ‡∏Å‡∏° (Nickname)">
                <input id="r-email" class="input-rs text-center" placeholder="Email">
                <input id="r-pass" type="password" class="input-rs text-center" placeholder="Password (6+)">
                <button onclick="Auth.register()" class="btn-rs w-full py-4 text-lg mt-4">REGISTER</button>
                <button onclick="UI.toggleAuth('log')" class="text-slate-400 text-sm mt-4 hover:text-white">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</button>
            </div>
        </div>
    </div>

    <div id="view-app" class="hidden flex flex-col h-screen">
        
        <header class="h-16 glass-panel m-2 mb-0 px-4 flex justify-between items-center z-40 rounded-xl">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-pink-500 to-purple-600 rounded-lg flex items-center justify-center text-xl font-bold shadow-lg">RS</div>
                <div>
                    <div class="font-bold font-display text-lg leading-none">‡πÄ‡∏õ‡πà‡∏≤‡∏â‡∏∏‡∏ö</div>
                    <div class="text-[10px] text-pink-400 tracking-widest font-bold">‚óè ONLINE</div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-right">
                    <div class="text-[9px] text-slate-400 font-bold uppercase">Balance</div>
                    <div class="font-mono text-xl font-bold text-yellow-400">‡∏ø<span id="u-credit">0</span></div>
                </div>
                <button onclick="UI.openProfile()" class="w-10 h-10 rounded-full bg-slate-800 border border-slate-600 overflow-hidden">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=RS" class="w-full h-full" id="u-avatar">
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-4 pb-24 relative">
            
            <div class="w-full h-32 rounded-2xl bg-gradient-to-r from-indigo-900 to-purple-900 mb-6 flex items-center justify-between px-8 relative overflow-hidden group border border-white/10">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-30"></div>
                <div class="relative z-10">
                    <h2 class="text-3xl font-black font-display italic text-white mb-1">BATTLE ARENA</h2>
                    <p class="text-pink-300 text-sm">‡∏ó‡πâ‡∏≤‡∏î‡∏ß‡∏•‡πÄ‡∏õ‡πà‡∏≤‡∏¢‡∏¥‡πâ‡∏á‡∏â‡∏∏‡∏ö ‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏±‡πâ‡∏ô!</p>
                </div>
                <i class="fa-solid fa-hand-fist text-8xl text-white/5 absolute -right-4 -bottom-4 group-hover:scale-110 transition duration-500"></i>
            </div>

            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold flex items-center gap-2"><i class="fa-solid fa-list-ul text-purple-500"></i> ‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                <button onclick="UI.openCreateRoom()" class="bg-white/10 hover:bg-white/20 border border-white/10 px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á
                </button>
            </div>

            <div id="room-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="col-span-full py-20 text-center text-slate-500 animate-pulse">
                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå RS...
                </div>
            </div>

        </main>

        <nav class="fixed bottom-0 inset-x-0 h-20 bg-[#090014]/90 backdrop-blur-xl border-t border-white/5 flex justify-around items-center z-50 pb-2">
            <button onclick="UI.nav('home')" class="flex flex-col items-center gap-1 text-pink-500 transition hover:scale-110">
                <i class="fa-solid fa-gamepad text-2xl"></i><span class="text-[10px] font-bold">‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°</span>
            </button>
            <button onclick="UI.nav('rank')" class="flex flex-col items-center gap-1 text-slate-500 hover:text-white transition hover:scale-110">
                <i class="fa-solid fa-trophy text-2xl"></i><span class="text-[10px] font-bold">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</span>
            </button>
            <div class="w-16"></div> <button onclick="UI.nav('history')" class="flex flex-col items-center gap-1 text-slate-500 hover:text-white transition hover:scale-110">
                <i class="fa-solid fa-clock-rotate-left text-2xl"></i><span class="text-[10px] font-bold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>
            </button>
            <button onclick="UI.nav('wallet')" class="flex flex-col items-center gap-1 text-slate-500 hover:text-white transition hover:scale-110">
                <i class="fa-solid fa-wallet text-2xl"></i><span class="text-[10px] font-bold">‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</span>
            </button>

            <button onclick="UI.openCreateRoom()" class="absolute -top-6 left-1/2 -translate-x-1/2 w-16 h-16 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full flex items-center justify-center text-white text-2xl shadow-[0_0_20px_rgba(217,70,239,0.5)] border-4 border-[#090014] animate-pulse">
                <i class="fa-solid fa-play"></i>
            </button>
        </nav>
    </div>

    <div id="game-room" class="fixed inset-0 z-[200] bg-[#090014] hidden flex-col">
        <div class="px-4 py-3 bg-slate-900/80 backdrop-blur border-b border-white/5 flex justify-between items-center z-20">
            <button onclick="Game.leave()" class="bg-white/10 w-10 h-10 rounded-lg flex items-center justify-center hover:bg-white/20"><i class="fa-solid fa-arrow-left"></i></button>
            <div class="text-center">
                <div class="font-display font-bold text-xl tracking-wider text-white" id="g-room-name">ARENA</div>
                <div class="text-[10px] text-pink-400 font-bold bg-pink-900/20 px-2 rounded" id="g-bet">BET: 0</div>
            </div>
            <div class="w-10"></div>
        </div>

        <div class="flex-1 relative flex flex-col items-center justify-center p-4 overflow-hidden">
            <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-purple-900/20 via-[#090014] to-[#090014]"></div>
            
            <div id="g-waiting" class="text-center z-10 hidden">
                <div class="w-32 h-32 border-4 border-dashed border-purple-500/30 rounded-full flex items-center justify-center mx-auto mb-6 animate-spin-slow">
                    <i class="fa-solid fa-user-plus text-4xl text-purple-500 animate-pulse"></i>
                </div>
                <h2 class="text-3xl font-black text-white mb-2">WAITING...</h2>
                <p class="text-slate-400 text-sm mb-4">‡∏£‡∏≠‡∏Ñ‡∏π‡πà‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á</p>
                <div class="bg-slate-900 px-4 py-2 rounded-lg border border-white/10 font-mono text-yellow-400" id="g-pass">PASS: -</div>
            </div>

            <div id="g-play" class="w-full max-w-md z-10 hidden flex-col items-center">
                
                <div class="w-full flex justify-between items-end mb-10 px-4">
                    <div class="text-center">
                        <div class="w-16 h-16 rounded-full bg-slate-800 border-2 border-blue-500 mb-2 overflow-hidden mx-auto"><img src="" id="p1-img" class="w-full h-full"></div>
                        <div class="text-blue-400 font-bold text-sm truncate w-20" id="p1-name">YOU</div>
                        <div class="text-4xl font-black text-white" id="p1-score">0</div>
                    </div>
                    <div class="text-2xl font-display text-slate-600 mb-4 italic">VS</div>
                    <div class="text-center">
                        <div class="w-16 h-16 rounded-full bg-slate-800 border-2 border-red-500 mb-2 overflow-hidden mx-auto"><img src="" id="p2-img" class="w-full h-full"></div>
                        <div class="text-red-400 font-bold text-sm truncate w-20" id="p2-name">ENEMY</div>
                        <div class="text-4xl font-black text-white" id="p2-score">0</div>
                    </div>
                </div>

                <div class="flex justify-between w-full px-8 mb-12 h-32 items-center">
                    <div id="hand-p1" class="hand-container text-blue-500 transform scale-x-[-1]"><i class="fa-regular fa-hand-back-fist"></i></div>
                    <div id="hand-p2" class="hand-container text-red-500"><i class="fa-regular fa-hand-back-fist"></i></div>
                </div>

                <div id="controls-ready" class="w-full text-center hidden">
                    <button onclick="Game.ready()" class="btn-rs w-full py-4 text-xl shadow-xl animate-pulse">READY FIGHT!</button>
                    <p class="text-xs text-slate-500 mt-2">‡∏Å‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</p>
                </div>

                <div id="controls-game" class="w-full hidden">
                    <div class="text-center mb-4 text-yellow-400 font-bold text-xl animate-bounce" id="status-text">CHOOSE!</div>
                    <div class="flex justify-center gap-4">
                        <div onclick="Game.move('rock')" class="rps-choice text-blue-400"><i class="fa-regular fa-hand-back-fist"></i></div>
                        <div onclick="Game.move('paper')" class="rps-choice text-yellow-400"><i class="fa-regular fa-hand"></i></div>
                        <div onclick="Game.move('scissors')" class="rps-choice text-pink-400"><i class="fa-regular fa-hand-scissors"></i></div>
                    </div>
                </div>
            </div>

            <div id="result-overlay" class="absolute inset-0 bg-black/80 z-50 hidden flex-col items-center justify-center backdrop-blur-sm">
                <div class="text-6xl mb-4 animate__animated animate__bounceIn" id="res-icon">üèÜ</div>
                <h1 class="text-5xl font-black font-display italic text-white mb-6 animate__animated animate__zoomIn" id="res-text">YOU WIN</h1>
                <button onclick="document.getElementById('result-overlay').classList.add('hidden')" class="px-8 py-3 bg-white text-black font-bold rounded-full hover:scale-105 transition">CONTINUE</button>
            </div>
        </div>

        <div class="h-16 bg-slate-900 border-t border-white/5 flex items-center px-4 gap-2 z-20">
            <input id="chat-input" class="flex-1 bg-slate-800 border-none rounded-full px-4 py-2 text-sm text-white focus:ring-1 focus:ring-purple-500 outline-none" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...">
            <button onclick="Game.sendChat()" class="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center text-white hover:bg-purple-500"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="modal-create" class="fixed inset-0 z-[150] bg-black/90 hidden flex items-center justify-center p-4">
        <div class="bg-[#1a0b2e] w-full max-w-md p-6 rounded-3xl border border-purple-500/20 shadow-2xl relative">
            <button onclick="document.getElementById('modal-create').style.display='none'" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h3 class="text-2xl font-bold text-white mb-6 text-center">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏•‡∏≠‡∏á</h3>
            <div class="space-y-4">
                <div><label class="text-xs text-slate-400 ml-1">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á</label><input id="c-name" class="input-rs" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏ô‡∏£‡∏ß‡∏¢"></div>
                <div><label class="text-xs text-slate-400 ml-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><input id="c-pass" class="input-rs" placeholder="‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs text-slate-400 ml-1">‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô (Credit)</label><input id="c-bet" type="number" class="input-rs" placeholder="0"></div>
                    <div><label class="text-xs text-slate-400 ml-1">‡∏ä‡∏ô‡∏∞‡∏Å‡∏µ‡πà‡∏ï‡∏≤ (Win)</label><input id="c-win" type="number" value="3" class="input-rs"></div>
                </div>
                <div class="flex items-center gap-2 p-3 bg-white/5 rounded-xl border border-white/5">
                    <input type="checkbox" id="c-demo" class="w-5 h-5 accent-pink-500" onchange="document.getElementById('c-bet').disabled=this.checked;document.getElementById('c-bet').value=this.checked?0:''">
                    <label for="c-demo" class="text-sm text-pink-300 font-bold">‡∏´‡πâ‡∏≠‡∏á‡∏ã‡πâ‡∏≠‡∏° (Demo / ‡πÑ‡∏°‡πà‡∏Å‡∏¥‡∏ô‡πÄ‡∏á‡∏¥‡∏ô)</label>
                </div>
                <button onclick="Lobby.create()" class="btn-rs w-full py-4 mt-2">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏¢</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = { apiKey: "AIzaSyAHAkBhypqyJuuL22tLrFKN7ZqdEsqGDTk", authDomain: "rsdm-9ca2a.firebaseapp.com", projectId: "rsdm-9ca2a", storageBucket: "rsdm-9ca2a.firebasestorage.app", messagingSenderId: "299212700124", appId: "1:299212700124:web:730160dae6bb1b09cbb719" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); const db = firebase.firestore();

        let currentUser=null, userDoc=null, currentRoomId=null, unsubRoom=null, allRooms=[];
        const sounds={ click:new Howl({src:['https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3']}), win:new Howl({src:['https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3']}), lose:new Howl({src:['https://assets.mixkit.co/active_storage/sfx/2034/2034-preview.mp3']}) };
        const iconMap = { rock: 'fa-hand-back-fist', paper: 'fa-hand', scissors: 'fa-hand-scissors' };

        // --- 2. AUTHENTICATION ---
        const Auth = {
            login: () => auth.signInWithEmailAndPassword(document.getElementById('l-email').value, document.getElementById('l-pass').value).catch(e => Swal.fire('Error', e.message, 'error')),
            register: () => {
                const n=document.getElementById('r-nick').value, e=document.getElementById('r-email').value, p=document.getElementById('r-pass').value;
                if(!n||!e||!p) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô','‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','warning');
                auth.createUserWithEmailAndPassword(e,p).then(c => {
                    db.collection('users').doc(c.user.uid).set({ nickname:n, email:e, credit:0, uid:c.user.uid, createdAt: new Date() });
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','success');
                }).catch(e => Swal.fire('Error', e.message, 'error'));
            },
            logout: () => auth.signOut()
        };

        // --- 3. LOBBY SYSTEM ---
        const Lobby = {
            init: () => {
                // Client-side Sort to fix Index Error
                db.collection('rooms').onSnapshot(s => {
                    allRooms = []; s.forEach(d => allRooms.push({id:d.id, ...d.data()}));
                    allRooms.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
                    Lobby.render();
                }, e => console.log('Lobby Error (Ignore if permission denied):', e));
            },
            render: () => {
                const list = document.getElementById('room-list');
                const txt = document.getElementById('search-input').value.toLowerCase();
                const filtered = allRooms.filter(r => r.roomName.toLowerCase().includes(txt));
                
                if(!filtered.length) { list.innerHTML = '<div class="col-span-full text-center text-slate-500 py-10">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡πâ‡∏≠‡∏á</div>'; return; }
                
                list.innerHTML = filtered.map(r => {
                    const isDemo = r.betAmount === 0;
                    const isFull = r.players.length >= 2;
                    return `<div onclick="Game.join('${r.id}', ${r.betAmount}, '${r.password}')" class="glass-panel p-5 cursor-pointer hover:border-pink-500 transition group relative overflow-hidden">
                        <div class="flex justify-between items-start relative z-10">
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] ${isDemo?'bg-green-500':'bg-pink-500'} px-2 rounded text-white font-bold">${isDemo?'DEMO':'BET'}</span>
                                    <h3 class="text-xl font-bold text-white group-hover:text-pink-400 transition truncate w-32">${r.roomName}</h3>
                                </div>
                                <div class="text-xs text-slate-400 mt-1 font-mono">‡∏ø${r.betAmount.toLocaleString()} ‚Ä¢ Best of ${r.maxWins}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-black ${isFull?'text-red-500':'text-green-500'}">${r.players.length}/2</div>
                                <div class="text-[10px] text-slate-500">PLAYERS</div>
                            </div>
                        </div>
                        <div class="absolute -bottom-4 -right-4 text-6xl text-white/5 rotate-12 group-hover:rotate-0 transition duration-500"><i class="fa-solid fa-hand-fist"></i></div>
                    </div>`;
                }).join('');
            },
            create: () => {
                const n = document.getElementById('c-name').value;
                if(!n) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô','‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á','warning');
                const isDemo = document.getElementById('c-demo').checked;
                db.collection('rooms').add({
                    roomName: n,
                    password: document.getElementById('c-pass').value,
                    betAmount: isDemo ? 0 : (parseInt(document.getElementById('c-bet').value)||0),
                    maxWins: parseInt(document.getElementById('c-win').value)||3,
                    players: [], scores: {}, moves: {}, ready: {},
                    roundState: 'idle', // idle, selecting, reveal
                    createdAt: new Date()
                }).then(() => {
                    document.getElementById('modal-create').style.display='none';
                    UI.toast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                });
            }
        };

        // --- 4. GAME LOGIC (RPS ONLY - AS REQUESTED TITLE) ---
        const Game = {
            join: async (rid, bet, pass) => {
                if(bet > userDoc.credit) return Swal.fire('‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠','‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô','error');
                if(pass) {
                    const {value:p} = await Swal.fire({title:'‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', input:'text', background:'#1a0b2e', color:'#fff'});
                    if(p !== pass) return Swal.fire('‡∏ú‡∏¥‡∏î','‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','error');
                }
                
                const ref = db.collection('rooms').doc(rid);
                const doc = await ref.get();
                const r = doc.data();
                
                if(!r.players.includes(currentUser.uid)) {
                    if(r.players.length >= 2) return Swal.fire('‡πÄ‡∏ï‡πá‡∏°','‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß','warning');
                    await ref.update({ 
                        players: firebase.firestore.FieldValue.arrayUnion(currentUser.uid),
                        [`meta.${currentUser.uid}`]: { name: userDoc.nickname, avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${userDoc.nickname}` }
                    });
                }
                Game.init(rid);
            },
            init: (rid) => {
                currentRoomId = rid;
                document.getElementById('view-app').classList.add('hidden'); // Hide Lobby
                document.getElementById('view-game').classList.remove('hidden'); // Show Game
                
                if(unsubRoom) unsubRoom();
                unsubRoom = db.collection('rooms').doc(rid).onSnapshot(snap => {
                    if(!snap.exists) { Game.leave(); return; }
                    const r = snap.data();
                    Game.render(r);
                });
            },
            render: (r) => {
                // Header
                document.getElementById('g-room-name').innerText = r.roomName;
                document.getElementById('g-bet').innerText = r.betAmount === 0 ? 'DEMO MODE' : `BET: ${r.betAmount}`;
                
                // Logic Flow
                const p1 = r.players[0];
                const p2 = r.players[1];
                const isFull = r.players.length === 2;

                // Toggle Views
                document.getElementById('g-waiting').classList.toggle('hidden', isFull);
                document.getElementById('g-play').classList.toggle('hidden', !isFull);
                
                if(isFull) {
                    const isMeP1 = currentUser.uid === p1;
                    const enemy = isMeP1 ? p2 : p1;
                    
                    // Render Players
                    document.getElementById('p1-name').innerText = "‡∏Ñ‡∏∏‡∏ì";
                    document.getElementById('p2-name').innerText = r.meta?.[enemy]?.name || "‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á";
                    document.getElementById('p1-img').src = r.meta?.[currentUser.uid]?.avatar;
                    document.getElementById('p2-img').src = r.meta?.[enemy]?.avatar;
                    document.getElementById('p1-score').innerText = isMeP1 ? (r.scores?.[p1]||0) : (r.scores?.[p2]||0);
                    document.getElementById('p2-score').innerText = isMeP1 ? (r.scores?.[p2]||0) : (r.scores?.[p1]||0);

                    // Check Winner
                    const myScore = isMeP1 ? (r.scores?.[p1]||0) : (r.scores?.[p2]||0);
                    const enemyScore = isMeP1 ? (r.scores?.[p2]||0) : (r.scores?.[p1]||0);
                    
                    if(myScore >= r.maxWins || enemyScore >= r.maxWins) {
                        Game.endGame(myScore > enemyScore, r.betAmount, rid, p1, p2);
                        return;
                    }

                    // Game State Machine
                    const ready1 = r.ready?.[p1];
                    const ready2 = r.ready?.[p2];
                    
                    if(!ready1 || !ready2) {
                        // Phase 1: Wait for Ready
                        document.getElementById('ready-section').classList.remove('hidden');
                        document.getElementById('controls-game').classList.add('hidden');
                        document.getElementById('controls-ready').classList.add('hidden'); // Not used, logic handled in ready-section
                        
                        const myReady = r.ready?.[currentUser.uid];
                        const btn = document.getElementById('btn-ready');
                        if(myReady) { btn.innerText = "‡∏£‡∏≠‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢..."; btn.disabled=true; btn.classList.add('opacity-50'); }
                        else { btn.innerText = "I'M READY!"; btn.disabled=false; btn.classList.remove('opacity-50'); }
                        
                        // Reset Hands
                        document.getElementById('hand-p1').innerHTML = '<i class="fa-regular fa-hand-back-fist"></i>';
                        document.getElementById('hand-p2').innerHTML = '<i class="fa-regular fa-hand-back-fist"></i>';
                        document.getElementById('hand-p1').classList.remove('shaking');
                        document.getElementById('hand-p2').classList.remove('shaking');
                    } else {
                        // Phase 2: Playing
                        document.getElementById('ready-section').classList.add('hidden');
                        document.getElementById('controls-game').classList.remove('hidden');

                        const myMove = r.moves?.[currentUser.uid];
                        const enMove = r.moves?.[enemy];

                        if(!myMove) {
                            document.getElementById('status-text').innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò!";
                            document.getElementById('hand-p1').classList.add('shaking');
                            document.getElementById('hand-p2').classList.add('shaking');
                        } else {
                            document.getElementById('status-text').innerText = "‡∏£‡∏≠‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á...";
                            // Highlight selected
                            document.querySelectorAll('.rps-choice').forEach(el => el.classList.remove('selected'));
                            // (Optional: add logic to highlight clicked btn)
                        }

                        // Reveal Logic (Only runs if both moved)
                        if(r.moves && Object.keys(r.moves).length === 2 && r.roundState !== 'revealed') {
                            // Trigger Reveal logic only once (usually by host/p1 to avoid race condition)
                            if(isMeP1) Game.resolveRound(rid, r);
                        }
                    }
                } else {
                    // Update Waiting Pass
                    document.getElementById('g-pass').innerText = "PASS: " + (r.password || '-');
                }
            },
            ready: () => {
                sounds.click.play();
                db.collection('rooms').doc(currentRoomId).update({
                    [`ready.${currentUser.uid}`]: true
                });
            },
            move: (choice) => {
                sounds.click.play();
                db.collection('rooms').doc(currentRoomId).update({
                    [`moves.${currentUser.uid}`]: choice
                });
            },
            resolveRound: (rid, r) => {
                // Determine winner logic
                const p1 = r.players[0];
                const p2 = r.players[1];
                const m1 = r.moves[p1];
                const m2 = r.moves[p2];
                
                let winner = null;
                if(m1 !== m2) {
                    if((m1==='rock' && m2==='scissors') || (m1==='paper' && m2==='rock') || (m1==='scissors' && m2==='paper')) winner = p1;
                    else winner = p2;
                }

                // Update DB with delay for animation
                // Note: In a real app, use Cloud Functions for security. Here we simulate on client.
                db.collection('rooms').doc(rid).update({ roundState: 'revealed' }); // Lock state
                
                setTimeout(() => {
                    const updates = { 
                        moves: {}, 
                        roundState: 'idle' // Back to start of round (but keep ready?)
                        // If you want players to re-ready every turn, set ready: {} 
                        // If you want continuous play until win, keep ready.
                    };
                    
                    if(winner) updates[`scores.${winner}`] = firebase.firestore.FieldValue.increment(1);
                    else {
                        // Draw - maybe notify?
                    }
                    
                    db.collection('rooms').doc(rid).update(updates);
                }, 2000); // 2s reveal time
            },
            endGame: (isWin, bet, rid, p1, p2) => {
                // Show Result
                const overlay = document.getElementById('result-overlay');
                const txt = document.getElementById('res-text');
                const icon = document.getElementById('res-icon');
                
                overlay.classList.remove('hidden');
                overlay.style.display = 'flex';
                
                if(isWin) {
                    icon.innerText = 'üèÜ';
                    txt.innerText = 'YOU WIN';
                    txt.className = 'text-5xl font-black font-display italic text-yellow-400 mb-6 animate__animated animate__zoomIn';
                    sounds.win.play();
                    confetti();
                    
                    // Update Credits (Winner handles DB update to avoid double count)
                    if(bet > 0) {
                        db.collection('users').doc(p1).update({ credit: firebase.firestore.FieldValue.increment(currentUser.uid===p1 ? bet : -bet) });
                        db.collection('users').doc(p2).update({ credit: firebase.firestore.FieldValue.increment(currentUser.uid===p2 ? bet : -bet) });
                        // Add Transaction History (omitted for brevity but recommended)
                    }
                    // Delete Room
                    db.collection('rooms').doc(rid).delete();
                } else {
                    icon.innerText = 'üíÄ';
                    txt.innerText = 'YOU LOSE';
                    txt.className = 'text-5xl font-black font-display italic text-red-500 mb-6 animate__animated animate__zoomIn';
                    sounds.lose.play();
                }
                
                Game.leave(true); // Leave without clearing listener yet (wait for user to close)
            },
            leave: (keepOverlay = false) => {
                if(unsubRoom) unsubRoom();
                if(!keepOverlay) document.getElementById('result-overlay').classList.add('hidden');
                document.getElementById('view-game').classList.add('hidden');
                document.getElementById('view-app').classList.remove('hidden');
            }
        };

        // --- 5. UI CONTROLLERS ---
        const UI = {
            toggleAuth: (mode) => {
                document.getElementById('login-form').style.display = mode==='reg'?'none':'block';
                document.getElementById('reg-form').style.display = mode==='reg'?'block':'none';
            },
            openCreateRoom: () => document.getElementById('modal-create').style.display='flex',
            openProfile: () => UI.nav('profile'),
            nav: (id) => {
                ['home','finance','history','profile'].forEach(p => {
                    document.getElementById(`page-${p}`).style.display = (p===id ? 'block' : 'none');
                    document.getElementById(`nav-${p}`).classList.toggle('active', p===id);
                });
                if(id==='finance') Finance.load(); if(id==='history') User.loadHistory();
            }
        };

        // --- INIT ---
        auth.onAuthStateChanged(user => {
            if(user) {
                currentUser = user;
                document.getElementById('view-auth').classList.add('hidden');
                document.getElementById('view-app').classList.remove('hidden');
                
                // Load User Data
                db.collection('users').doc(user.uid).onSnapshot(doc => {
                    if(!doc.exists) return; // Handle new user manually if needed
                    userDoc = doc.data();
                    document.getElementById('u-credit').innerText = userDoc.credit.toLocaleString();
                    document.getElementById('u-avatar').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${userDoc.nickname}`;
                    // Update Profile Inputs
                    document.getElementById('p-nick').value = userDoc.nickname;
                });
                
                Lobby.init();
            } else {
                document.getElementById('view-auth').classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
