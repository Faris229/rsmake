<!DOCTYPE html>
<html lang="th" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ระบบเก็บโค้ด EA | ใช้งานง่าย</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Prompt', 'sans-serif'] },
                    colors: {
                        primary: '#3b82f6', // สีฟ้าหลัก
                        dark: '#1e293b'     // สีพื้นหลังโหมดมืด
                    }
                }
            }
        }
    </script>

    <style>
        /* CSS ปรับแต่งพิเศษ */
        body { transition: background-color 0.3s, color 0.3s; }
        
        /* การ์ดรายการ */
        .bot-card {
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
        }
        .dark .bot-card { border-color: #334155; }
        .bot-card:active { transform: scale(0.98); }

        /* ปุ่มกด */
        .btn-action {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            padding: 12px 20px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        .btn-action:active { transform: translateY(2px); }

        /* พื้นที่เขียนโค้ด */
        textarea {
            font-family: 'Sarabun', monospace;
            line-height: 1.5;
            resize: none;
        }

        /* สถานะ */
        .status-badge {
            padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;
            display: inline-flex; align-items: center; gap: 5px;
        }

        /* Overlay Editor */
        #editor-page {
            position: fixed; inset: 0; z-index: 100;
            display: none; flex-direction: column;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">

    <div id="view-auth" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-100 dark:bg-slate-900">
        <div class="w-full max-w-sm bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-xl">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-500 text-white rounded-2xl flex items-center justify-center text-3xl mx-auto mb-3 shadow-lg">
                    <i class="fa-solid fa-code"></i>
                </div>
                <h1 class="text-2xl font-bold">EA Code Keeper</h1>
                <p class="text-slate-500 text-sm">เข้าสู่ระบบเพื่อจัดการโค้ดของคุณ</p>
            </div>
            
            <div id="login-box">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">อีเมล</label>
                        <input id="l-email" class="w-full p-3 rounded-xl border bg-gray-50 dark:bg-slate-700 dark:border-slate-600 outline-none focus:ring-2 focus:ring-blue-500" placeholder="อีเมลของคุณ">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">รหัสผ่าน</label>
                        <input id="l-pass" type="password" class="w-full p-3 rounded-xl border bg-gray-50 dark:bg-slate-700 dark:border-slate-600 outline-none focus:ring-2 focus:ring-blue-500" placeholder="รหัสผ่าน">
                    </div>
                    <button onclick="Auth.login()" class="btn-action w-full bg-blue-600 text-white hover:bg-blue-700 shadow-lg shadow-blue-500/30">
                        เข้าสู่ระบบ
                    </button>
                    <div class="text-center pt-2">
                        <button onclick="UI.toggleAuth('reg')" class="text-blue-500 text-sm font-bold">สมัครสมาชิกใหม่</button>
                    </div>
                </div>
            </div>

            <div id="reg-box" class="hidden space-y-4">
                <input id="r-nick" class="w-full p-3 rounded-xl border bg-gray-50 dark:bg-slate-700 dark:border-slate-600" placeholder="ชื่อเล่น">
                <input id="r-email" class="w-full p-3 rounded-xl border bg-gray-50 dark:bg-slate-700 dark:border-slate-600" placeholder="อีเมล">
                <input id="r-pass" type="password" class="w-full p-3 rounded-xl border bg-gray-50 dark:bg-slate-700 dark:border-slate-600" placeholder="รหัสผ่าน (6 ตัวขึ้นไป)">
                <button onclick="Auth.register()" class="btn-action w-full bg-green-500 text-white hover:bg-green-600 shadow-lg">ยืนยันการสมัคร</button>
                <button onclick="UI.toggleAuth('log')" class="w-full text-center text-sm text-slate-500">ย้อนกลับ</button>
            </div>
        </div>
    </div>

    <div id="view-app" class="hidden flex flex-col h-screen">
        
        <nav class="bg-white dark:bg-slate-800 px-5 py-4 shadow-sm flex justify-between items-center z-10">
            <div>
                <h1 class="text-xl font-bold text-blue-600 dark:text-blue-400">EA STUDIO</h1>
                <p class="text-xs text-slate-500" id="u-display">ยินดีต้อนรับ, ผู้ใช้งาน</p>
            </div>
            <div class="flex gap-3">
                <button onclick="UI.toggleTheme()" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-slate-700 text-slate-600 dark:text-yellow-400 flex items-center justify-center transition">
                    <i id="theme-icon" class="fa-solid fa-moon"></i>
                </button>
                <button onclick="Auth.logout()" class="w-10 h-10 rounded-full bg-red-100 dark:bg-red-900/30 text-red-500 flex items-center justify-center">
                    <i class="fa-solid fa-power-off"></i>
                </button>
            </div>
        </nav>

        <main class="flex-1 overflow-y-auto p-5 pb-24">
            
            <div class="flex gap-3 mb-6">
                <div class="relative flex-1">
                    <i class="fa-solid fa-search absolute left-3 top-3.5 text-slate-400"></i>
                    <input id="search-input" onkeyup="Bot.render()" class="w-full pl-10 pr-4 py-3 rounded-xl border-none shadow-sm bg-white dark:bg-slate-800 outline-none" placeholder="ค้นหาชื่อบอท...">
                </div>
            </div>

            <h2 class="text-sm font-bold text-slate-500 mb-3 uppercase tracking-wider">รายการทั้งหมด</h2>
            <div id="bot-list" class="space-y-3">
                <div class="text-center py-10 text-slate-400">กำลังโหลดข้อมูล...</div>
            </div>

        </main>

        <button onclick="UI.openEditor()" class="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-xl shadow-blue-600/40 flex items-center justify-center text-2xl hover:scale-110 transition z-40">
            <i class="fa-solid fa-plus"></i>
        </button>
    </div>

    <div id="editor-page" class="bg-gray-100 dark:bg-slate-900">
        
        <div class="bg-white dark:bg-slate-800 px-4 py-3 shadow-md flex justify-between items-center z-50">
            <button onclick="UI.closeEditor()" class="text-slate-500 hover:text-slate-800 dark:hover:text-white flex items-center gap-2 px-2 py-1">
                <i class="fa-solid fa-chevron-left"></i> กลับ
            </button>
            <span class="font-bold text-lg">แก้ไขโค้ด</span>
            <button onclick="Bot.save()" class="text-green-600 font-bold bg-green-100 dark:bg-green-900/30 px-4 py-1.5 rounded-lg text-sm">
                บันทึก
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 pb-32">
            <input type="hidden" id="edit-id">
            
            <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm mb-4 space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 mb-1 block">ชื่อโปรเจกต์</label>
                    <input id="edit-name" class="w-full p-3 rounded-lg border bg-gray-50 dark:bg-slate-900 dark:border-slate-700 outline-none font-bold text-lg" placeholder="ตั้งชื่อบอท เช่น MA Cross">
                </div>
                
                <div>
                    <label class="text-xs font-bold text-slate-500 mb-2 block">สถานะการใช้งาน</label>
                    <div class="flex gap-2">
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="status" value="ok" class="peer sr-only" checked>
                            <div class="text-center py-2 rounded-lg border dark:border-slate-700 peer-checked:bg-green-500 peer-checked:text-white peer-checked:border-green-500 transition text-sm">
                                <i class="fa-solid fa-check-circle mr-1"></i> ปกติ
                            </div>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="status" value="bug" class="peer sr-only">
                            <div class="text-center py-2 rounded-lg border dark:border-slate-700 peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-500 transition text-sm">
                                <i class="fa-solid fa-triangle-exclamation mr-1"></i> มีปัญหา
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm overflow-hidden flex flex-col h-[500px]">
                <div class="bg-slate-100 dark:bg-slate-900 px-4 py-2 flex justify-between items-center border-b dark:border-slate-700">
                    <span class="text-xs font-bold text-slate-500">SOURCE CODE</span>
                    <button onclick="Bot.copy()" class="text-xs text-blue-500 font-bold hover:underline"><i class="fa-regular fa-copy"></i> คัดลอกทั้งหมด</button>
                </div>
                <textarea id="edit-code" class="flex-1 p-4 bg-slate-50 dark:bg-[#1e1e1e] dark:text-gray-300 outline-none text-sm font-mono" placeholder="// ใส่โค้ดของคุณที่นี่..."></textarea>
            </div>

            <button id="btn-delete" onclick="Bot.delete()" class="w-full mt-6 py-3 text-red-500 bg-white dark:bg-slate-800 border border-red-200 rounded-xl font-bold shadow-sm hidden">
                <i class="fa-solid fa-trash mr-2"></i> ลบโปรเจกต์นี้
            </button>
        </div>
    </div>

    <script>
        // --- 1. FIREBASE CONFIG (ใส่ค่าของคุณ) ---
        const firebaseConfig = { apiKey: "AIzaSyAHAkBhypqyJuuL22tLrFKN7ZqdEsqGDTk", authDomain: "rsdm-9ca2a.firebaseapp.com", projectId: "rsdm-9ca2a", storageBucket: "rsdm-9ca2a.firebasestorage.app", messagingSenderId: "299212700124", appId: "1:299212700124:web:730160dae6bb1b09cbb719" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); const db = firebase.firestore();

        let currentUser = null;
        let allBots = [];

        // --- 2. UI CONTROLLER ---
        const UI = {
            toggleAuth: (mode) => {
                document.getElementById('login-box').style.display = mode === 'reg' ? 'none' : 'block';
                document.getElementById('reg-box').style.display = mode === 'reg' ? 'block' : 'none';
            },
            toggleTheme: () => {
                const isDark = document.documentElement.classList.toggle('dark');
                document.documentElement.classList.toggle('light');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                document.getElementById('theme-icon').className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
            },
            toast: (msg, icon = 'success') => {
                Swal.fire({
                    toast: true, position: 'top-end', icon: icon, title: msg,
                    showConfirmButton: false, timer: 1500,
                    background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
                    color: document.documentElement.classList.contains('dark') ? '#fff' : '#000'
                });
            },
            openEditor: (botId = null) => {
                const page = document.getElementById('editor-page');
                page.style.display = 'flex';
                
                // Reset Form
                document.getElementById('edit-id').value = '';
                document.getElementById('edit-name').value = '';
                document.getElementById('edit-code').value = '';
                document.getElementById('btn-delete').classList.add('hidden');
                document.querySelector('input[name="status"][value="ok"]').checked = true;

                if (botId) {
                    const bot = allBots.find(b => b.id === botId);
                    if (bot) {
                        document.getElementById('edit-id').value = bot.id;
                        document.getElementById('edit-name').value = bot.name;
                        document.getElementById('edit-code').value = bot.code;
                        document.getElementById('btn-delete').classList.remove('hidden');
                        document.querySelector(`input[name="status"][value="${bot.status}"]`).checked = true;
                    }
                }
            },
            closeEditor: () => {
                document.getElementById('editor-page').style.display = 'none';
            }
        };

        // --- 3. AUTHENTICATION ---
        const Auth = {
            login: () => {
                auth.signInWithEmailAndPassword(document.getElementById('l-email').value, document.getElementById('l-pass').value)
                    .catch(e => UI.toast('อีเมลหรือรหัสผ่านผิด', 'error'));
            },
            register: () => {
                const n = document.getElementById('r-nick').value, e = document.getElementById('r-email').value, p = document.getElementById('r-pass').value;
                if(!n || !e || !p) return UI.toast('กรอกข้อมูลให้ครบ', 'warning');
                auth.createUserWithEmailAndPassword(e, p).then(c => {
                    db.collection('users').doc(c.user.uid).set({ nickname: n, email: e });
                    UI.toast('สมัครสำเร็จ');
                }).catch(e => UI.toast(e.message, 'error'));
            },
            logout: () => auth.signOut()
        };

        // --- 4. BOT LOGIC ---
        const Bot = {
            init: () => {
                // Client-side Sort (Fix Loading Issue)
                db.collection('ea_bots').where('uid', '==', currentUser.uid).onSnapshot(s => {
                    allBots = [];
                    s.forEach(d => allBots.push({ id: d.id, ...d.data() }));
                    allBots.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                    Bot.render();
                }, e => document.getElementById('bot-list').innerHTML = '<div class="text-center py-10 text-red-400">โหลดข้อมูลไม่สำเร็จ (ลองรีเฟรช)</div>');
            },
            render: () => {
                const list = document.getElementById('bot-list');
                const txt = document.getElementById('search-input').value.toLowerCase();
                const filtered = allBots.filter(b => b.name.toLowerCase().includes(txt));

                if (filtered.length === 0) {
                    list.innerHTML = `<div class="text-center py-12 text-slate-400"><i class="fa-solid fa-folder-open text-4xl mb-2"></i><p>ไม่พบข้อมูล</p></div>`;
                    return;
                }

                list.innerHTML = filtered.map(b => {
                    const statusHtml = b.status === 'ok' 
                        ? `<span class="status-badge bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400"><i class="fa-solid fa-check-circle"></i> ปกติ</span>`
                        : `<span class="status-badge bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400"><i class="fa-solid fa-triangle-exclamation"></i> แก้ไข</span>`;
                    
                    const date = b.timestamp ? new Date(b.timestamp.toDate()).toLocaleDateString('th-TH') : '-';

                    return `
                    <div onclick="UI.openEditor('${b.id}')" class="bot-card bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm cursor-pointer hover:shadow-md flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-gray-100 dark:bg-slate-700 rounded-lg flex items-center justify-center text-xl text-blue-500">
                                <i class="fa-solid fa-file-code"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg leading-tight dark:text-white">${b.name}</h3>
                                <div class="text-xs text-slate-500 mt-1 flex items-center gap-2">
                                    <i class="fa-regular fa-clock"></i> ${date}
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            ${statusHtml}
                        </div>
                    </div>`;
                }).join('');
            },
            save: () => {
                const id = document.getElementById('edit-id').value;
                const name = document.getElementById('edit-name').value;
                const code = document.getElementById('edit-code').value;
                const status = document.querySelector('input[name="status"]:checked').value;

                if (!name) return UI.toast('กรุณาตั้งชื่อโปรเจกต์', 'warning');

                const data = { uid: currentUser.uid, name, code, status, timestamp: new Date() };

                if (id) {
                    db.collection('ea_bots').doc(id).update(data).then(() => { UI.toast('อัปเดตเรียบร้อย'); UI.closeEditor(); });
                } else {
                    db.collection('ea_bots').add(data).then(() => { UI.toast('สร้างใหม่เรียบร้อย'); UI.closeEditor(); });
                }
            },
            delete: () => {
                const id = document.getElementById('edit-id').value;
                Swal.fire({
                    title: 'ยืนยันการลบ?', text: "ข้อมูลจะหายไปถาวร", icon: 'warning',
                    showCancelButton: true, confirmButtonText: 'ลบเลย', cancelButtonText: 'ยกเลิก', confirmButtonColor: '#ef4444'
                }).then((r) => {
                    if (r.isConfirmed) {
                        db.collection('ea_bots').doc(id).delete().then(() => { UI.toast('ลบแล้ว'); UI.closeEditor(); });
                    }
                });
            },
            copy: () => {
                const code = document.getElementById('edit-code');
                code.select(); navigator.clipboard.writeText(code.value).then(() => UI.toast('คัดลอกโค้ดแล้ว'));
            }
        };

        // --- INIT ---
        // Auto Load Theme
        if(localStorage.getItem('theme') === 'dark') {
            document.documentElement.classList.add('dark');
            document.getElementById('theme-icon').className = 'fa-solid fa-sun';
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                db.collection('users').doc(user.uid).get().then(doc => {
                    const u = doc.exists ? doc.data() : { nickname: 'User' };
                    document.getElementById('u-display').innerText = `สวัสดี, ${u.nickname}`;
                });
                document.getElementById('view-auth').classList.add('hidden');
                document.getElementById('view-app').classList.remove('hidden');
                Bot.init();
            } else {
                document.getElementById('view-auth').classList.remove('hidden');
                document.getElementById('view-app').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
