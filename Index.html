<!DOCTYPE html>
<html lang="th" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EA Code Studio | Minimal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class', // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ Dark Mode ‡πÅ‡∏ö‡∏ö Class-based
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'Prompt', 'sans-serif'], 
                        mono: ['JetBrains Mono', 'monospace'] 
                    },
                    colors: {
                        // Light Mode Colors
                        light: {
                            bg: '#f8fafc',
                            card: '#ffffff',
                            text: '#0f172a',
                            border: '#e2e8f0',
                            primary: '#3b82f6'
                        },
                        // Dark Mode Colors
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            text: '#f1f5f9',
                            border: '#334155',
                            primary: '#60a5fa'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Setup */
        body { 
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden; /* App-like feel */
        }

        /* Scrollbar Styling */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark .custom-scroll::-webkit-scrollbar-thumb { background: #475569; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Auth Container Center */
        .auth-container {
            display: flex; align-items: center; justify-content: center;
            min-height: 100vh; width: 100%;
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 24px 24px;
        }
        .dark .auth-container {
            background-image: radial-gradient(#1e293b 1px, transparent 1px);
        }

        /* Layout Grid */
        .app-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            width: 100vw;
        }
        
        /* Mobile Layout */
        @media (max-width: 768px) {
            .app-layout {
                grid-template-columns: 1fr;
                grid-template-rows: 60px 1fr;
            }
            .sidebar { display: none; } /* Hide sidebar on mobile initially */
            .sidebar.mobile-active { 
                display: flex; position: fixed; inset: 0; z-index: 50; width: 100%; 
            }
        }

        /* Inputs */
        .input-clean {
            width: 100%; padding: 12px 16px;
            border-radius: 10px; outline: none; transition: all 0.2s;
            font-size: 14px;
        }
        /* Light Mode Input */
        .input-clean { background: #f1f5f9; border: 1px solid #e2e8f0; color: #0f172a; }
        .input-clean:focus { border-color: #3b82f6; background: #fff; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        /* Dark Mode Input */
        .dark .input-clean { background: #0f172a; border: 1px solid #334155; color: #f8fafc; }
        .dark .input-clean:focus { border-color: #60a5fa; background: #1e293b; box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1); }

        /* Code Editor Area */
        .editor-wrapper {
            display: flex; flex-direction: column; height: 100%;
            border-radius: 12px; overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        .dark .editor-wrapper { border-color: #334155; }

        .line-numbers {
            padding: 20px 10px; text-align: right;
            font-family: 'JetBrains Mono', monospace; font-size: 14px; line-height: 1.6;
            color: #94a3b8; background: #f8fafc; border-right: 1px solid #e2e8f0;
            user-select: none;
        }
        .dark .line-numbers { background: #0f172a; border-color: #334155; color: #64748b; }

        .code-textarea {
            flex: 1; padding: 20px;
            font-family: 'JetBrains Mono', monospace; font-size: 14px; line-height: 1.6;
            border: none; outline: none; resize: none; white-space: pre;
            background: #ffffff; color: #334155;
        }
        .dark .code-textarea { background: #1e293b; color: #e2e8f0; }

        /* Buttons */
        .btn-primary {
            background-color: #0f172a; color: white;
            padding: 10px 20px; border-radius: 8px; font-weight: 500; font-size: 14px;
            transition: 0.2s; display: inline-flex; align-items: center; gap: 8px;
            cursor: pointer;
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .dark .btn-primary { background-color: #3b82f6; color: white; }
        .dark .btn-primary:hover { background-color: #2563eb; }

        /* Mobile View Switcher */
        .view-section { display: none; width: 100%; height: 100%; }
        .view-section.active { display: flex; flex-direction: column; animation: fadeIn 0.3s ease; }

        /* Status Badge */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .st-green { background-color: #22c55e; box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2); }
        .st-yellow { background-color: #eab308; box-shadow: 0 0 0 2px rgba(234, 179, 8, 0.2); }
        .st-red { background-color: #ef4444; box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2); }
    </style>
</head>
<body class="bg-light-bg dark:bg-dark-bg text-light-text dark:text-dark-text">

    <div id="view-auth" class="auth-container fixed inset-0 z-50">
        <div class="w-full max-w-md bg-white dark:bg-dark-card p-8 rounded-2xl shadow-xl border border-gray-100 dark:border-gray-800 animate-slide-up mx-4">
            
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-600 rounded-xl mx-auto flex items-center justify-center text-white text-3xl font-bold mb-4 shadow-lg shadow-blue-500/20">
                    <i class="fa-solid fa-code"></i>
                </div>
                <h1 class="text-2xl font-bold mb-1">EA Code Studio</h1>
                <p class="text-slate-500 text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡πâ‡∏î‡∏ö‡∏≠‡∏ó‡πÄ‡∏ó‡∏£‡∏î</p>
            </div>

            <div id="login-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input id="l-email" type="email" class="input-clean" placeholder="name@example.com">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input id="l-pass" type="password" class="input-clean" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button onclick="Auth.login()" class="btn-primary w-full justify-center py-3 mt-2">
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </button>
                <div class="text-center pt-4">
                    <button onclick="UI.toggleAuth('reg')" class="text-sm text-blue-500 hover:underline">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                </div>
            </div>

            <div id="reg-form" class="space-y-4 hidden">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô (Nickname)</label>
                    <input id="r-nick" type="text" class="input-clean" placeholder="CoderName">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input id="r-email" type="email" class="input-clean" placeholder="name@example.com">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input id="r-pass" type="password" class="input-clean" placeholder="‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô 6 ‡∏ï‡∏±‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ">
                </div>
                <button onclick="Auth.register()" class="btn-primary w-full justify-center py-3 mt-2">
                    ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                </button>
                <div class="text-center pt-4">
                    <button onclick="UI.toggleAuth('log')" class="text-sm text-slate-500 hover:text-slate-800 dark:hover:text-white">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                </div>
            </div>

        </div>
    </div>

    <div id="view-app" class="app-layout hidden">

        <header class="col-span-2 bg-white dark:bg-dark-card border-b border-gray-200 dark:border-gray-800 flex justify-between items-center px-6 z-40">
            <div class="flex items-center gap-4">
                <button onclick="UI.toggleSidebar()" class="md:hidden text-slate-500 hover:text-slate-900 dark:hover:text-white">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
                
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">
                        <i class="fa-solid fa-terminal text-sm"></i>
                    </div>
                    <span class="font-bold text-lg tracking-tight hidden sm:block">EA STUDIO</span>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <button onclick="Theme.toggle()" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center text-slate-500 hover:text-blue-500 transition">
                    <i id="theme-icon" class="fa-solid fa-moon"></i>
                </button>
                
                <div class="h-6 w-px bg-gray-200 dark:bg-gray-700"></div>

                <div class="flex items-center gap-3">
                    <div class="text-right hidden sm:block">
                        <div class="text-xs text-slate-400 uppercase font-bold">User</div>
                        <div class="text-sm font-bold" id="u-name-display">Guest</div>
                    </div>
                    <button onclick="Auth.logout()" class="text-slate-400 hover:text-red-500 transition px-2">
                        <i class="fa-solid fa-right-from-bracket text-lg"></i>
                    </button>
                </div>
            </div>
        </header>

        <aside id="sidebar" class="sidebar bg-gray-50 dark:bg-[#0f172a] border-r border-gray-200 dark:border-gray-800 flex flex-col row-span-2 overflow-hidden transition-all duration-300">
            <div class="p-4 border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-dark-card sticky top-0 z-10">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Projects</h3>
                    <button onclick="BotSystem.create()" class="text-blue-500 hover:text-blue-600 text-xs font-bold flex items-center gap-1 bg-blue-50 dark:bg-blue-900/30 px-2 py-1 rounded">
                        <i class="fa-solid fa-plus"></i> ‡πÉ‡∏´‡∏°‡πà
                    </button>
                </div>
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-3 top-3 text-slate-400 text-xs"></i>
                    <input id="search-bot" onkeyup="BotSystem.renderList()" class="input-clean pl-8 py-2 text-xs rounded-full" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠...">
                </div>
            </div>

            <div id="bot-list" class="flex-1 overflow-y-auto p-2 space-y-2 custom-scroll">
                <div class="text-center py-10 text-slate-400 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>

            <button onclick="UI.toggleSidebar()" class="md:hidden p-4 text-center text-slate-500 border-t border-gray-200 dark:border-gray-800 bg-white dark:bg-dark-card font-bold">
                ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π
            </button>
        </aside>

        <main class="bg-white dark:bg-[#131720] relative flex flex-col h-full overflow-hidden">
            
            <div id="editor-empty" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400 z-0">
                <i class="fa-solid fa-code text-6xl mb-4 opacity-20"></i>
                <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà</p>
            </div>

            <div id="editor-ui" class="flex flex-col h-full hidden z-10 relative">
                
                <div class="h-14 border-b border-gray-200 dark:border-gray-800 flex items-center justify-between px-6 bg-white dark:bg-dark-card">
                    <div class="flex items-center gap-4 flex-1">
                        <input id="edit-name" class="bg-transparent text-lg font-bold text-slate-800 dark:text-white outline-none w-full placeholder-slate-400" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå...">
                    </div>
                    <div class="flex items-center gap-2">
                        <select id="edit-status" class="bg-gray-100 dark:bg-slate-800 text-xs font-bold rounded-lg px-3 py-1.5 border-none outline-none text-slate-600 dark:text-slate-300 cursor-pointer">
                            <option value="working">üü¢ ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</option>
                            <option value="testing">üü° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö</option>
                            <option value="buggy">üî¥ ‡∏°‡∏µ‡∏ö‡∏±‡πä‡∏Å</option>
                        </select>
                        <div class="h-6 w-px bg-gray-200 dark:bg-gray-700 mx-2"></div>
                        <button onclick="BotSystem.save()" class="btn-primary py-1.5 px-4 text-sm bg-blue-600 hover:bg-blue-500 text-white rounded-lg shadow-sm">
                            <i class="fa-solid fa-save"></i> <span class="hidden sm:inline">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
                        </button>
                        <button onclick="BotSystem.delete()" class="text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 px-3 py-1.5 rounded-lg transition" title="‡∏•‡∏ö">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>

                <div class="flex-1 p-4 bg-gray-50 dark:bg-[#0d1117] overflow-hidden">
                    <div class="editor-wrapper h-full shadow-inner bg-white dark:bg-[#1e1e1e]">
                        <input type="hidden" id="edit-id">
                        <div class="flex h-full">
                            <div class="line-numbers w-12 hidden sm:block">1<br>2<br>3<br>4<br>5<br>6...</div>
                            <textarea id="edit-code" class="code-textarea custom-scroll" placeholder="// ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÇ‡∏Ñ‡πâ‡∏î EA ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="h-10 border-t border-gray-200 dark:border-gray-800 bg-white dark:bg-dark-card flex items-center justify-between px-4 text-xs text-slate-500 font-mono">
                    <div class="flex items-center gap-4">
                        <span><i class="fa-solid fa-file-code mr-1"></i> MQ4 Source File</span>
                        <span>UTF-8</span>
                    </div>
                    <button onclick="BotSystem.copy()" class="hover:text-blue-500 flex items-center gap-1">
                        <i class="fa-regular fa-copy"></i> Copy All
                    </button>
                </div>
            </div>

        </main>

    </div>

    <script>
        // --- CONFIG (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ---
        const firebaseConfig = { apiKey: "AIzaSyAHAkBhypqyJuuL22tLrFKN7ZqdEsqGDTk", authDomain: "rsdm-9ca2a.firebaseapp.com", projectId: "rsdm-9ca2a", storageBucket: "rsdm-9ca2a.firebasestorage.app", messagingSenderId: "299212700124", appId: "1:299212700124:web:730160dae6bb1b09cbb719" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); const db = firebase.firestore();

        let currentUser = null;
        let allBots = [];
        let currentBotId = null;

        // --- THEME MANAGER ---
        const Theme = {
            init: () => {
                const saved = localStorage.getItem('theme');
                if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                    document.getElementById('theme-icon').className = 'fa-solid fa-sun';
                } else {
                    document.documentElement.classList.remove('dark');
                    document.getElementById('theme-icon').className = 'fa-solid fa-moon';
                }
            },
            toggle: () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                document.getElementById('theme-icon').className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
            }
        };
        Theme.init();

        // --- UI CONTROLLER ---
        const UI = {
            toggleAuth: (mode) => {
                document.getElementById('login-form').style.display = mode === 'reg' ? 'none' : 'block';
                document.getElementById('reg-form').style.display = mode === 'reg' ? 'block' : 'none';
            },
            toast: (msg, icon = 'success') => {
                Swal.fire({
                    toast: true, position: 'top-end', icon: icon, title: msg,
                    showConfirmButton: false, timer: 1500,
                    background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
                    color: document.documentElement.classList.contains('dark') ? '#fff' : '#000'
                });
            },
            toggleSidebar: () => {
                const sidebar = document.getElementById('sidebar');
                if (sidebar.classList.contains('mobile-active')) {
                    sidebar.classList.remove('mobile-active');
                    sidebar.style.display = 'none'; // Force hide on mobile close
                } else {
                    sidebar.classList.add('mobile-active');
                    sidebar.style.display = 'flex';
                }
                // Reset display for desktop resize
                if(window.innerWidth > 768) sidebar.style.display = 'flex';
            },
            showEditor: (show) => {
                document.getElementById('editor-empty').style.display = show ? 'none' : 'flex';
                document.getElementById('editor-ui').classList.toggle('hidden', !show);
                if (window.innerWidth <= 768 && show) {
                    // On mobile, close sidebar when opening editor
                    document.getElementById('sidebar').classList.remove('mobile-active');
                    document.getElementById('sidebar').style.display = 'none';
                }
            }
        };

        // --- AUTH ---
        const Auth = {
            login: () => {
                const e = document.getElementById('l-email').value;
                const p = document.getElementById('l-pass').value;
                auth.signInWithEmailAndPassword(e, p).catch(er => UI.toast(er.message, 'error'));
            },
            register: () => {
                const n = document.getElementById('r-nick').value;
                const e = document.getElementById('r-email').value;
                const p = document.getElementById('r-pass').value;
                if(!n||!e||!p) return UI.toast('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'warning');
                auth.createUserWithEmailAndPassword(e, p).then(c => {
                    db.collection('users').doc(c.user.uid).set({ nickname: n, email: e });
                    UI.toast('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                }).catch(er => UI.toast(er.message, 'error'));
            },
            logout: () => auth.signOut()
        };

        // --- BOT SYSTEM ---
        const BotSystem = {
            init: () => {
                // Client-side Sort to Fix Index Issue
                db.collection('ea_bots').where('uid', '==', currentUser.uid).onSnapshot(snap => {
                    allBots = [];
                    snap.forEach(doc => allBots.push({ id: doc.id, ...doc.data() }));
                    allBots.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                    BotSystem.renderList();
                });
            },

            renderList: () => {
                const list = document.getElementById('bot-list');
                const search = document.getElementById('search-bot').value.toLowerCase();
                const filtered = allBots.filter(b => b.name.toLowerCase().includes(search));

                if (filtered.length === 0) {
                    list.innerHTML = `<div class="text-center p-4 text-slate-400 text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
                    return;
                }

                list.innerHTML = filtered.map(b => {
                    let statusColor = 'st-green';
                    if (b.status === 'testing') statusColor = 'st-yellow';
                    if (b.status === 'buggy') statusColor = 'st-red';
                    
                    const isActive = b.id === currentBotId ? 'bg-blue-50 dark:bg-blue-900/20 border-blue-500' : 'bg-white dark:bg-dark-card border-transparent hover:bg-gray-50 dark:hover:bg-slate-800';

                    return `
                    <div onclick="BotSystem.select('${b.id}')" class="p-3 rounded-xl border ${isActive} cursor-pointer transition mb-2 shadow-sm">
                        <div class="flex justify-between items-start mb-1">
                            <h4 class="font-bold text-sm truncate w-32 dark:text-white">${b.name}</h4>
                            <div class="status-dot ${statusColor}"></div>
                        </div>
                        <div class="text-[10px] text-slate-400 font-mono truncate">${b.code.substring(0, 30)}...</div>
                    </div>`;
                }).join('');
            },

            create: () => {
                currentBotId = null;
                UI.showEditor(true);
                document.getElementById('edit-id').value = '';
                document.getElementById('edit-name').value = 'Untitled Bot';
                document.getElementById('edit-code').value = '';
                document.getElementById('edit-status').value = 'working';
                document.getElementById('edit-name').focus();
            },

            select: (id) => {
                const bot = allBots.find(b => b.id === id);
                if (!bot) return;
                
                currentBotId = id;
                UI.showEditor(true);
                BotSystem.renderList(); // Refresh active highlight

                document.getElementById('edit-id').value = bot.id;
                document.getElementById('edit-name').value = bot.name;
                document.getElementById('edit-code').value = bot.code;
                document.getElementById('edit-status').value = bot.status || 'working';
            },

            save: () => {
                const id = document.getElementById('edit-id').value;
                const name = document.getElementById('edit-name').value;
                const code = document.getElementById('edit-code').value;
                const status = document.getElementById('edit-status').value;

                if (!name) return UI.toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠', 'warning');

                const data = { uid: currentUser.uid, name, code, status, timestamp: new Date() };

                if (id) {
                    db.collection('ea_bots').doc(id).update(data).then(() => UI.toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'));
                } else {
                    db.collection('ea_bots').add(data).then((doc) => {
                        UI.toast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                        currentBotId = doc.id;
                        document.getElementById('edit-id').value = doc.id;
                    });
                }
            },

            delete: () => {
                if (!currentBotId) return;
                Swal.fire({
                    title: '‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå?', icon: 'warning',
                    showCancelButton: true, confirmButtonColor: '#ef4444', confirmButtonText: '‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
                    background: document.body.classList.contains('dark') ? '#1e293b' : '#fff'
                }).then((r) => {
                    if (r.isConfirmed) {
                        db.collection('ea_bots').doc(currentBotId).delete().then(() => {
                            UI.toast('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
                            currentBotId = null;
                            UI.showEditor(false);
                        });
                    }
                });
            },

            copy: () => {
                const c = document.getElementById('edit-code');
                c.select(); navigator.clipboard.writeText(c.value).then(() => UI.toast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß'));
            }
        };

        // --- INIT ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                db.collection('users').doc(user.uid).get().then(doc => {
                    const u = doc.exists ? doc.data() : { nickname: 'User' };
                    document.getElementById('u-name-display').innerText = u.nickname;
                });
                document.getElementById('view-auth').classList.add('hidden');
                document.getElementById('view-app').classList.remove('hidden');
                document.getElementById('view-app').classList.add('app-layout'); // Apply grid layout
                BotSystem.init();
            } else {
                document.getElementById('view-auth').classList.remove('hidden');
                document.getElementById('view-app').classList.add('hidden');
                document.getElementById('view-app').classList.remove('app-layout');
            }
        });
    </script>
</body>
</html>
