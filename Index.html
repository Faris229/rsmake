<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EA TRADER | CODE STATION</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Sarabun', 'sans-serif'], 
                        mono: ['JetBrains Mono', 'monospace'] 
                    },
                    colors: { 
                        trade: { 
                            bg: '#0d1117', 
                            panel: '#161b22', 
                            border: '#30363d',
                            green: '#238636',
                            red: '#da3633',
                            blue: '#58a6ff',
                            text: '#c9d1d9'
                        } 
                    },
                    animation: { 'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>

    <style>
        /* --- CORE STYLES --- */
        body { 
            background-color: #0d1117; 
            color: #c9d1d9; 
            overflow: hidden; /* App-like feel */
        }

        /* Scrollbar like VS Code */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #0d1117; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #58a6ff; }

        /* Utilities */
        .border-trade { border: 1px solid #30363d; }
        .bg-panel { background-color: #161b22; }
        .text-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Grid Layout for Desktop */
        .app-layout {
            display: grid;
            grid-template-columns: 250px 1fr;
            grid-template-rows: 50px 1fr 200px;
            height: 100vh;
            width: 100vw;
        }
        
        /* Mobile Layout Adjustment */
        @media (max-width: 768px) {
            .app-layout {
                grid-template-columns: 1fr;
                grid-template-rows: 60px 1fr 60px; /* Header, Content, BottomNav */
            }
            .desktop-only { display: none !important; }
            .mobile-only { display: flex !important; }
        }

        /* Input Styling */
        .input-code {
            background: #0d1117; border: 1px solid #30363d;
            color: #e6edf3; padding: 8px 12px;
            font-family: 'JetBrains Mono', monospace;
            width: 100%; outline: none; transition: 0.2s;
        }
        .input-code:focus { border-color: #58a6ff; }

        /* Status Dot */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .st-online { background: #238636; box-shadow: 0 0 5px #238636; }
        .st-busy { background: #d29922; box-shadow: 0 0 5px #d29922; }
        .st-error { background: #da3633; box-shadow: 0 0 5px #da3633; }

        /* Code Editor Mockup */
        .editor-container { position: relative; height: 100%; display: flex; flex-direction: column; }
        .editor-textarea {
            flex: 1; background: #0d1117; color: #e6edf3;
            border: none; padding: 15px; resize: none; outline: none;
            font-family: 'JetBrains Mono', monospace; font-size: 13px; line-height: 1.5;
            white-space: pre; overflow: auto;
        }

        /* Terminal Logs */
        .terminal-log { font-family: 'JetBrains Mono', monospace; font-size: 11px; padding: 2px 0; }
        .log-info { color: #58a6ff; }
        .log-success { color: #238636; }
        .log-warn { color: #d29922; }
        .log-err { color: #da3633; }

        /* Ticker Tape */
        .ticker-wrap { width: 100%; overflow: hidden; background: #0d1117; border-bottom: 1px solid #30363d; white-space: nowrap; }
        .ticker { display: inline-block; animation: marquee 30s linear infinite; }
        .ticker-item { display: inline-block; padding: 0 20px; font-family: 'JetBrains Mono', monospace; font-size: 12px; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* Full Page Loader */
        #splash { position: fixed; inset: 0; background: #0d1117; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .loader-bar { width: 200px; height: 2px; background: #30363d; margin-top: 15px; overflow: hidden; }
        .loader-fill { width: 50%; height: 100%; background: #238636; animation: loading 1s infinite linear; }
        @keyframes loading { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(2px); z-index: 100; display: none; justify-content: center; align-items: center; }
        .modal-content { background: #161b22; width: 90%; max-width: 800px; height: 80vh; border: 1px solid #30363d; box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: flex; flex-direction: column; }
    </style>
</head>
<body>

    <div id="splash">
        <h1 class="text-4xl font-bold text-white tracking-widest font-mono">EA<span class="text-trade-green">_STUDIO</span></h1>
        <div class="loader-bar"><div class="loader-fill"></div></div>
        <p class="text-xs text-slate-500 mt-2 font-mono">INITIALIZING SYSTEM...</p>
    </div>

    <div id="view-auth" class="fixed inset-0 z-50 flex items-center justify-center bg-trade-bg hidden">
        <div class="w-full max-w-md bg-panel border-trade p-8 shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-trade-green"></div>
            <h2 class="text-2xl font-bold text-white mb-1 font-mono">ACCESS TERMINAL</h2>
            <p class="text-xs text-slate-500 mb-6 font-mono">> Please authenticate to continue_</p>
            
            <div id="login-form" class="space-y-4">
                <div>
                    <label class="text-xs text-trade-blue font-mono mb-1 block">USR:</label>
                    <input id="l-email" class="input-code" placeholder="user@domain.com">
                </div>
                <div>
                    <label class="text-xs text-trade-blue font-mono mb-1 block">PWD:</label>
                    <input id="l-pass" type="password" class="input-code" placeholder="••••••••">
                </div>
                <button onclick="Auth.login()" class="w-full bg-trade-green text-white font-bold py-3 mt-4 hover:bg-green-700 transition font-mono text-sm border border-transparent hover:border-green-400">
                    [ LOGIN ]
                </button>
                <div class="text-center mt-4">
                    <button onclick="UI.toggleAuth('reg')" class="text-xs text-slate-500 hover:text-white font-mono underline">Create New Account</button>
                </div>
            </div>

            <div id="reg-form" class="space-y-4 hidden">
                <div>
                    <label class="text-xs text-trade-blue font-mono mb-1 block">ALIAS:</label>
                    <input id="r-nick" class="input-code" placeholder="CoderName">
                </div>
                <div>
                    <label class="text-xs text-trade-blue font-mono mb-1 block">EMAIL:</label>
                    <input id="r-email" class="input-code" placeholder="user@domain.com">
                </div>
                <div>
                    <label class="text-xs text-trade-blue font-mono mb-1 block">PASS:</label>
                    <input id="r-pass" type="password" class="input-code" placeholder="••••••••">
                </div>
                <button onclick="Auth.register()" class="w-full bg-trade-blue text-white font-bold py-3 mt-4 hover:bg-blue-700 transition font-mono text-sm">
                    [ REGISTER ]
                </button>
                <button onclick="UI.toggleAuth('log')" class="w-full text-xs text-slate-500 mt-2 hover:text-white font-mono">[ BACK ]</button>
            </div>
        </div>
    </div>

    <div id="view-app" class="app-layout hidden">
        
        <header class="col-span-2 bg-panel border-b border-trade flex justify-between items-center px-4 relative z-20">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-trade-green flex items-center justify-center font-bold text-black font-mono">EA</div>
                <div>
                    <div class="font-bold text-sm text-white tracking-wide">EA STUDIO <span class="text-xs text-slate-500 font-mono">v2.4.0</span></div>
                    <div class="text-[10px] text-trade-green font-mono"><span class="animate-pulse">●</span> SYSTEM ONLINE</div>
                </div>
            </div>
            
            <div class="hidden md:block flex-1 mx-8 overflow-hidden relative h-full flex items-center">
                <div class="ticker-wrap">
                    <div class="ticker" id="stock-ticker">
                        <span class="ticker-item text-green-500">EURUSD +0.45%</span>
                        <span class="ticker-item text-red-500">GBPUSD -0.12%</span>
                        <span class="ticker-item text-green-500">XAUUSD +1.20%</span>
                        <span class="ticker-item text-slate-400">BTCUSD 0.00%</span>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <div class="text-[10px] text-slate-400 font-mono">ACCOUNT</div>
                    <div class="text-xs font-bold text-trade-blue font-mono" id="u-name-display">Guest</div>
                </div>
                <button onclick="Auth.logout()" class="text-red-500 hover:text-white border border-transparent hover:border-red-500 px-3 py-1 text-xs font-mono transition">
                    [EXIT]
                </button>
            </div>
        </header>

        <aside class="bg-trade-bg border-r border-trade hidden md:flex flex-col p-2 row-span-2">
            <div class="text-[10px] text-slate-500 font-mono mb-2 px-2">EXPLORER</div>
            <nav class="space-y-1">
                <button onclick="UI.switchTab('dash')" class="w-full text-left px-3 py-2 text-sm text-slate-300 hover:bg-panel hover:text-white border-l-2 border-transparent hover:border-trade-blue font-mono transition flex items-center gap-3">
                    <i class="fa-solid fa-chart-line w-4"></i> DASHBOARD
                </button>
                <button onclick="UI.switchTab('bots')" class="w-full text-left px-3 py-2 text-sm text-slate-300 hover:bg-panel hover:text-white border-l-2 border-transparent hover:border-trade-green font-mono transition flex items-center gap-3">
                    <i class="fa-solid fa-code w-4"></i> MY SOURCE CODE
                </button>
                <button onclick="UI.switchTab('market')" class="w-full text-left px-3 py-2 text-sm text-slate-300 hover:bg-panel hover:text-white border-l-2 border-transparent hover:border-yellow-500 font-mono transition flex items-center gap-3">
                    <i class="fa-solid fa-cart-shopping w-4"></i> MARKETPLACE
                </button>
            </nav>

            <div class="mt-auto">
                <div class="bg-panel p-3 border border-trade">
                    <div class="text-[10px] text-slate-500 mb-1">SERVER STATUS</div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-xs font-mono">CPU:</span>
                        <div class="flex-1 h-1 bg-slate-700"><div class="h-full bg-trade-green" style="width: 24%"></div></div>
                        <span class="text-xs font-mono">24%</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-mono">RAM:</span>
                        <div class="flex-1 h-1 bg-slate-700"><div class="h-full bg-trade-blue" style="width: 58%"></div></div>
                        <span class="text-xs font-mono">58%</span>
                    </div>
                </div>
            </div>
        </aside>

        <main class="bg-trade-bg relative overflow-y-auto p-4 md:p-6" id="main-scroll">
            
            <div id="page-dash" class="space-y-6">
                <div class="flex justify-between items-end">
                    <h2 class="text-2xl font-bold text-white font-mono"><span class="text-trade-green">></span> DASHBOARD_OVERVIEW</h2>
                    <button onclick="Admin.fixData()" class="text-xs text-yellow-500 hover:underline font-mono">[DEBUG: Fix Data]</button>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-panel border border-trade p-4">
                        <div class="text-xs text-slate-500 font-mono">TOTAL BOTS</div>
                        <div class="text-2xl font-bold text-white mt-1 font-mono" id="stat-bots">0</div>
                        <div class="text-[10px] text-trade-green mt-1">+2 from yesterday</div>
                    </div>
                    <div class="bg-panel border border-trade p-4">
                        <div class="text-xs text-slate-500 font-mono">ACTIVE SESSIONS</div>
                        <div class="text-2xl font-bold text-white mt-1 font-mono">1</div>
                    </div>
                    <div class="bg-panel border border-trade p-4">
                        <div class="text-xs text-slate-500 font-mono">SUCCESS RATE</div>
                        <div class="text-2xl font-bold text-trade-blue mt-1 font-mono">98.5%</div>
                    </div>
                    <div class="bg-panel border border-trade p-4">
                        <div class="text-xs text-slate-500 font-mono">CREDITS</div>
                        <div class="text-2xl font-bold text-yellow-500 mt-1 font-mono">∞</div>
                    </div>
                </div>

                <div class="bg-panel border border-trade p-4">
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-sm font-bold font-mono">PERFORMANCE ANALYTICS</div>
                        <div class="flex gap-2">
                            <span class="text-[10px] bg-slate-700 px-2 py-0.5 text-white cursor-pointer">1H</span>
                            <span class="text-[10px] bg-trade-green px-2 py-0.5 text-white cursor-pointer">1D</span>
                            <span class="text-[10px] bg-slate-700 px-2 py-0.5 text-white cursor-pointer">1W</span>
                        </div>
                    </div>
                    <div id="chart-area" class="h-64 w-full"></div>
                </div>
            </div>

            <div id="page-bots" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-white font-mono"><span class="text-trade-blue">></span> MY_PROJECTS</h2>
                    <button onclick="UI.openEditor()" class="bg-trade-green text-black px-4 py-2 text-xs font-bold hover:bg-green-400 font-mono flex items-center gap-2">
                        <i class="fa-solid fa-plus"></i> NEW_FILE
                    </button>
                </div>

                <div class="relative mb-4">
                    <i class="fa-solid fa-search absolute left-3 top-3 text-slate-500 text-xs"></i>
                    <input id="search-bot" onkeyup="BotSystem.filter()" class="bg-panel border border-trade text-slate-300 text-xs p-2 pl-8 w-full font-mono focus:border-trade-blue outline-none" placeholder="Search filename...">
                </div>

                <div id="bot-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="col-span-full py-10 text-center font-mono text-slate-500 text-xs">
                        // INITIALIZING DATABASE CONNECTION...
                    </div>
                </div>
            </div>
            
            <div id="page-market" class="hidden text-center py-20">
                <i class="fa-solid fa-shop text-6xl text-slate-700 mb-4"></i>
                <h2 class="text-xl font-bold font-mono text-slate-400">MARKETPLACE_OFFLINE</h2>
                <p class="text-xs text-slate-600 mt-2">Server connection required.</p>
            </div>

        </main>

        <footer class="col-span-2 bg-panel border-t border-trade p-2 overflow-hidden flex flex-col hidden md:flex">
            <div class="flex justify-between items-center border-b border-trade pb-1 mb-1 px-2">
                <div class="text-[10px] font-bold text-slate-400 font-mono">TERMINAL</div>
                <div class="text-[10px] text-slate-600 font-mono cursor-pointer hover:text-white" onclick="document.getElementById('terminal-content').innerHTML=''">[CLEAR]</div>
            </div>
            <div id="terminal-content" class="flex-1 overflow-y-auto px-2 custom-scrollbar h-full">
                <div class="terminal-log"><span class="text-slate-500">20:45:01</span> <span class="log-info">INFO</span> System initialized successfully.</div>
                <div class="terminal-log"><span class="text-slate-500">20:45:02</span> <span class="log-success">SUCCESS</span> Connected to Firebase [Asia-Southeast1].</div>
            </div>
        </footer>

        <div class="md:hidden bg-panel border-t border-trade flex justify-around items-center px-2 py-3 z-50 fixed bottom-0 left-0 w-full">
            <button onclick="UI.switchTab('dash')" class="flex flex-col items-center gap-1 text-slate-400 hover:text-white">
                <i class="fa-solid fa-chart-line text-lg"></i>
                <span class="text-[9px] font-mono">HOME</span>
            </button>
            <button onclick="UI.openEditor()" class="flex flex-col items-center justify-center bg-trade-blue w-12 h-12 rounded-full -mt-6 border-4 border-trade-bg text-black shadow-lg shadow-blue-500/20">
                <i class="fa-solid fa-plus text-xl"></i>
            </button>
            <button onclick="UI.switchTab('bots')" class="flex flex-col items-center gap-1 text-slate-400 hover:text-white">
                <i class="fa-solid fa-code text-lg"></i>
                <span class="text-[9px] font-mono">CODE</span>
            </button>
        </div>

    </div>

    <div id="modal-editor" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center p-3 bg-[#0d1117] border-b border-trade">
                <div class="flex items-center gap-2">
                    <i class="fa-brands fa-js text-yellow-400 text-lg"></i>
                    <input id="bot-name" class="bg-transparent border-none text-white font-mono text-sm focus:ring-0 outline-none w-48" placeholder="Untitled_Bot.mq4">
                </div>
                <div class="flex gap-2">
                    <button onclick="BotSystem.copyCode()" class="text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1 border border-trade font-mono"><i class="fa-regular fa-copy"></i> COPY</button>
                    <button onclick="UI.closeEditor()" class="text-slate-400 hover:text-white px-2"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>

            <div class="editor-container flex-1 relative">
                <div class="absolute left-0 top-0 bottom-0 w-10 bg-[#0d1117] border-r border-trade text-right pr-2 pt-4 text-slate-600 font-mono text-[11px] select-none">
                    1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>...
                </div>
                <textarea id="code-input" class="editor-textarea pl-12" placeholder="// EA TRADER v1.0
// Coded by User

void OnStart() {
    Print('Hello World');
}"></textarea>
            </div>

            <div class="p-3 bg-[#0d1117] border-t border-trade flex justify-between items-center">
                <div class="flex gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="bot-status" value="working" class="accent-green-500" checked>
                        <span class="text-xs text-slate-400 font-mono">Working</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="bot-status" value="buggy" class="accent-red-500">
                        <span class="text-xs text-slate-400 font-mono">Buggy</span>
                    </label>
                </div>
                <div class="flex gap-2">
                    <input type="hidden" id="edit-id">
                    <button id="btn-delete" onclick="BotSystem.delete()" class="text-xs text-red-500 hover:text-red-400 font-mono px-3 hidden">DELETE FILE</button>
                    <button onclick="BotSystem.save()" class="bg-trade-blue hover:bg-blue-600 text-white text-xs font-mono font-bold px-4 py-1.5 border border-blue-500">SAVE FILE</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Init Splash
        setTimeout(() => { document.getElementById('splash').style.display = 'none'; }, 2000);

        // --- 1. FIREBASE CONFIG (REPLACE WITH YOURS) ---
        const firebaseConfig = { apiKey: "AIzaSyAHAkBhypqyJuuL22tLrFKN7ZqdEsqGDTk", authDomain: "rsdm-9ca2a.firebaseapp.com", projectId: "rsdm-9ca2a", storageBucket: "rsdm-9ca2a.firebasestorage.app", messagingSenderId: "299212700124", appId: "1:299212700124:web:730160dae6bb1b09cbb719" };
        
        try {
            firebase.initializeApp(firebaseConfig);
        } catch(e) { console.error(e); }

        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;
        let allBots = [];

        // --- 2. TERMINAL LOG SYSTEM ---
        function log(type, msg) {
            const term = document.getElementById('terminal-content');
            const time = new Date().toLocaleTimeString('th-TH');
            let color = 'text-slate-300';
            if(type === 'INFO') color = 'log-info';
            if(type === 'SUCCESS') color = 'log-success';
            if(type === 'ERROR') color = 'log-err';
            
            const line = document.createElement('div');
            line.className = 'terminal-log';
            line.innerHTML = `<span class="text-slate-500">${time}</span> <span class="${color}">${type}</span> ${msg}`;
            term.appendChild(line);
            term.scrollTop = term.scrollHeight;
        }

        // --- 3. CHART (ApexCharts) ---
        function initChart() {
            var options = {
                series: [{ name: 'Profit', data: [30, 40, 35, 50, 49, 60, 70, 91, 125] }],
                chart: { type: 'area', height: 250, toolbar: { show: false }, background: 'transparent' },
                colors: ['#238636'],
                stroke: { curve: 'straight', width: 2 },
                fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.7, opacityTo: 0.1, stops: [0, 90, 100] } },
                dataLabels: { enabled: false },
                grid: { borderColor: '#30363d', strokeDashArray: 4 },
                xaxis: { categories: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep'], labels: { style: { colors: '#8b949e', fontFamily: 'JetBrains Mono' } }, axisBorder: { show: false }, axisTicks: { show: false } },
                yaxis: { labels: { style: { colors: '#8b949e', fontFamily: 'JetBrains Mono' } } },
                theme: { mode: 'dark' }
            };
            var chart = new ApexCharts(document.querySelector("#chart-area"), options);
            chart.render();
        }

        // --- 4. AUTHENTICATION ---
        const Auth = {
            login: () => {
                const e = document.getElementById('l-email').value;
                const p = document.getElementById('l-pass').value;
                auth.signInWithEmailAndPassword(e, p).catch(err => {
                    Swal.fire({icon:'error', title:'Access Denied', text: err.message, background:'#161b22', color:'#fff'});
                    log('ERROR', `Login failed: ${err.message}`);
                });
            },
            register: () => {
                const n = document.getElementById('r-nick').value;
                const e = document.getElementById('r-email').value;
                const p = document.getElementById('r-pass').value;
                auth.createUserWithEmailAndPassword(e, p).then(cred => {
                    db.collection('users').doc(cred.user.uid).set({ nickname: n, email: e, uid: cred.user.uid });
                    log('SUCCESS', 'New user registered: ' + e);
                }).catch(err => Swal.fire({icon:'error', title:'Error', text: err.message}));
            },
            logout: () => auth.signOut()
        };

        // --- 5. UI CONTROLLER ---
        const UI = {
            toggleAuth: (mode) => {
                document.getElementById('login-form').style.display = mode === 'reg' ? 'none' : 'block';
                document.getElementById('reg-form').style.display = mode === 'reg' ? 'block' : 'none';
            },
            switchTab: (id) => {
                ['dash','bots','market'].forEach(p => { document.getElementById(`page-${p}`).classList.add('hidden'); });
                document.getElementById(`page-${id}`).classList.remove('hidden');
                if(id === 'dash') setTimeout(initChart, 100);
            },
            openEditor: (botId = null) => {
                const m = document.getElementById('modal-editor');
                m.style.display = 'flex';
                // Reset
                document.getElementById('bot-name').value = '';
                document.getElementById('code-input').value = '';
                document.getElementById('edit-id').value = '';
                document.getElementById('btn-delete').classList.add('hidden');
                
                if(botId) {
                    const bot = allBots.find(b => b.id === botId);
                    if(bot) {
                        document.getElementById('bot-name').value = bot.name;
                        document.getElementById('code-input').value = bot.code;
                        document.getElementById('edit-id').value = bot.id;
                        document.getElementById('btn-delete').classList.remove('hidden');
                        log('INFO', 'Opened file: ' + bot.name);
                    }
                }
            },
            closeEditor: () => { document.getElementById('modal-editor').style.display = 'none'; }
        };

        // --- 6. BOT SYSTEM (CRUD + CLIENT SORT) ---
        const BotSystem = {
            init: () => {
                // Fetch WITHOUT orderBy to fix index issue
                db.collection('ea_bots').where('uid', '==', currentUser.uid)
                  .onSnapshot(snapshot => {
                      allBots = [];
                      snapshot.forEach(doc => allBots.push({ id: doc.id, ...doc.data() }));
                      // Sort Client Side
                      allBots.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                      BotSystem.render();
                      document.getElementById('stat-bots').innerText = allBots.length;
                      log('INFO', `Loaded ${allBots.length} projects.`);
                  }, error => {
                      console.error(error);
                      log('ERROR', 'Failed to fetch data. Database might be empty.');
                      document.getElementById('bot-list').innerHTML = '<div class="col-span-full text-center text-red-500 font-mono py-10">DATABASE CONNECTION FAILED / EMPTY</div>';
                  });
            },
            render: () => {
                const list = document.getElementById('bot-grid');
                const search = document.getElementById('search-bot').value.toLowerCase();
                const filtered = allBots.filter(b => b.name.toLowerCase().includes(search));

                if(filtered.length === 0) { list.innerHTML = `<div class="col-span-full text-center text-slate-600 font-mono py-10">// NO FILES FOUND</div>`; return; }

                list.innerHTML = filtered.map(b => {
                    const date = b.timestamp ? new Date(b.timestamp.toDate()).toLocaleDateString('en-GB') : 'N/A';
                    const statusClass = b.status === 'working' ? 'st-online' : (b.status === 'buggy' ? 'st-error' : 'st-busy');
                    const statusText = b.status === 'working' ? 'STABLE' : (b.status === 'buggy' ? 'BUG DETECTED' : 'TESTING');
                    
                    return `
                    <div onclick="UI.openEditor('${b.id}')" class="bg-panel border-trade p-4 cursor-pointer hover:border-blue-500 transition group relative">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-2">
                                <i class="fa-regular fa-file-code text-trade-blue text-lg"></i>
                                <span class="font-bold text-white text-sm font-mono group-hover:text-blue-400">${b.name}</span>
                            </div>
                            <div class="flex items-center gap-1 text-[10px] text-slate-500 font-mono border border-trade px-1">
                                <div class="status-dot ${statusClass}"></div> ${statusText}
                            </div>
                        </div>
                        <div class="h-16 bg-[#0d1117] p-2 mb-2 overflow-hidden">
                            <code class="text-[10px] text-slate-500 font-mono whitespace-pre-wrap">${b.code.slice(0,100)}...</code>
                        </div>
                        <div class="flex justify-between items-center text-[10px] text-slate-500 font-mono">
                            <span>LAST_MOD: ${date}</span>
                            <span>SIZE: ${b.code.length}B</span>
                        </div>
                    </div>`;
                }).join('');
            },
            filter: () => BotSystem.render(),
            save: () => {
                const id = document.getElementById('edit-id').value;
                const name = document.getElementById('bot-name').value;
                const code = document.getElementById('code-input').value;
                const status = document.querySelector('input[name="bot-status"]:checked').value;

                if(!name || !code) return Swal.fire({title:'Error', text:'Code cannot be empty', icon:'warning'});

                const data = { uid: currentUser.uid, name, code, status, timestamp: new Date() };

                if(id) db.collection('ea_bots').doc(id).update(data).then(() => { UI.closeEditor(); log('SUCCESS', 'File updated: '+name); });
                else db.collection('ea_bots').add(data).then(() => { UI.closeEditor(); log('SUCCESS', 'File created: '+name); });
            },
            delete: () => {
                const id = document.getElementById('edit-id').value;
                db.collection('ea_bots').doc(id).delete().then(() => { UI.closeEditor(); log('WARN', 'File deleted.'); });
            },
            copyCode: () => {
                const c = document.getElementById('code-input');
                c.select(); document.execCommand('copy');
                log('INFO', 'Code copied to clipboard.');
            }
        };

        // --- ADMIN FIX ---
        const Admin = {
            fixData: async () => {
                const c = confirm("Initialize dummy data?");
                if(c) {
                    await db.collection('ea_bots').add({
                        uid: currentUser.uid, name: 'MACD_Strategy_v1.mq4', code: '// Auto-generated\nvoid OnTick() {\n  if(OrdersTotal()==0) OrderSend(...);\n}', status: 'working', timestamp: new Date()
                    });
                    log('SUCCESS', 'Dummy data injected.');
                }
            }
        };

        // --- INIT ---
        auth.onAuthStateChanged(user => {
            if(user) {
                currentUser = user;
                db.collection('users').doc(user.uid).get().then(doc => {
                    const u = doc.exists ? doc.data() : { nickname: 'Coder' };
                    document.getElementById('u-name-display').innerText = u.nickname;
                });
                document.getElementById('view-auth').classList.add('hidden');
                document.getElementById('view-app').classList.remove('hidden');
                UI.switchTab('dash');
                BotSystem.init();
            } else {
                document.getElementById('view-auth').classList.remove('hidden');
                document.getElementById('view-app').classList.add('hidden');
            }
        });
        
        // Stock Ticker Animation Data Injection
        setInterval(() => {
            // Fake update prices color
        }, 2000);

    </script>
</body>
</html>
