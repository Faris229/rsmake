<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Zone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Prompt', sans-serif; background: #ffffff; color: #1a1a1a; }
        .input-clean { width: 100%; padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 10px; outline: none; }
        .input-clean:focus { border-color: #000; }
        .btn-black { background: #000; color: #fff; padding: 12px; border-radius: 10px; width: 100%; font-weight: 600; transition: 0.2s; }
        .btn-black:hover { transform: scale(0.98); }
        .xo-cell { height: 90px; background: #f9fafb; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 3rem; font-weight: 800; cursor: pointer; border: 2px solid transparent; }
        .xo-cell:hover { border-color: #e5e7eb; }
        .xo-cell.X { color: #ef4444; } .xo-cell.O { color: #3b82f6; }
        .rps-btn { width: 80px; height: 80px; border-radius: 50%; background: #fff; border: 4px solid #f3f4f6; display: flex; align-items: center; justify-content: center; font-size: 2rem; cursor: pointer; transition: 0.2s; }
        .rps-btn:hover { border-color: #000; transform: scale(1.1); }
        .rps-btn.selected { background: #000; color: #fff; border-color: #000; }
        
        /* Timer Bar */
        .timer-wrap { width: 100%; height: 6px; background: #eee; border-radius: 3px; overflow: hidden; margin-top: 10px; display: none; }
        .timer-bar { height: 100%; background: #ef4444; width: 100%; transition: width 1s linear; }
    </style>
</head>
<body>

    <div id="maintenance-view" class="fixed inset-0 bg-white z-[999] flex flex-col items-center justify-center hidden">
        <i class="fa-solid fa-screwdriver-wrench text-6xl mb-4 text-gray-300"></i>
        <h1 class="text-3xl font-bold">ปิดปรับปรุงระบบ</h1>
        <p class="text-gray-500 mt-2">กรุณากลับมาใหม่ภายหลัง</p>
    </div>

    <div id="auth-view" class="fixed inset-0 bg-white z-50 flex items-center justify-center p-6 hidden">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-4xl font-bold mb-2 tracking-tighter" id="site-name-auth">GAME ZONE.</h1>
            <p class="text-gray-400 mb-8">เข้าสู่ระบบเพื่อเดิมพัน</p>
            <div id="login-form" class="space-y-4">
                <input id="l-email" class="input-clean" placeholder="Email">
                <input id="l-pass" type="password" class="input-clean" placeholder="Password">
                <button onclick="Auth.login()" class="btn-black">เข้าสู่ระบบ</button>
                <div class="mt-4 text-xs text-gray-500 cursor-pointer hover:underline" onclick="UI.toggleAuth('reg')">สมัครสมาชิกใหม่</div>
            </div>
            <div id="reg-form" class="space-y-4 hidden">
                <input id="r-name" class="input-clean" placeholder="ชื่อเล่น">
                <input id="r-email" class="input-clean" placeholder="Email">
                <input id="r-pass" type="password" class="input-clean" placeholder="Password">
                <button onclick="Auth.register()" class="btn-black bg-gray-800">ยืนยันสมัคร</button>
                <div class="mt-4 text-xs text-gray-500 cursor-pointer hover:underline" onclick="UI.toggleAuth('log')">กลับไปล็อกอิน</div>
            </div>
        </div>
    </div>

    <div id="app-view" class="hidden min-h-screen flex flex-col">
        <nav class="flex justify-between items-center p-4 md:p-8 border-b border-gray-100 bg-white/80 backdrop-blur sticky top-0 z-40">
            <div class="flex items-center gap-4">
                <div class="font-bold text-xl tracking-tighter" id="site-name-nav">ZONE.</div>
                <div class="hidden md:block">
                    <div id="u-name" class="font-bold text-sm">...</div>
                    <div class="text-xs text-gray-400">Credit: <span id="u-credit" class="text-black font-bold">0</span></div>
                </div>
            </div>
            <div class="flex gap-2">
                <a id="btn-contact" href="#" target="_blank" class="bg-black text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-gray-800">
                    <i class="fa-brands fa-facebook-messenger"></i> ติดต่อแอดมิน
                </a>
                <button onclick="Auth.logout()" class="w-10 h-10 rounded-lg bg-gray-100 hover:bg-red-50 hover:text-red-500"><i class="fa-solid fa-power-off"></i></button>
            </div>
        </nav>

        <div class="flex-1 max-w-5xl mx-auto w-full p-4 md:p-8">
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 mb-8 text-sm text-gray-600">
                <div class="font-bold text-black mb-1"><i class="fa-solid fa-book-open"></i> กติกาการเล่น</div>
                <p id="site-rules">...</p>
            </div>

            <div id="lobby-view">
                <h2 class="text-2xl font-bold mb-6">ห้องเดิมพัน</h2>
                <div id="room-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
        </div>
    </div>

    <div id="game-view" class="fixed inset-0 bg-white z-[100] hidden flex flex-col">
        <div class="p-4 border-b flex justify-between items-center">
            <button onclick="Game.leave()" class="text-gray-400 hover:text-black font-bold"><i class="fa-solid fa-arrow-left"></i> ออกจากห้อง</button>
            <div class="text-right"><div id="g-name" class="font-bold">Room</div><div class="text-xs text-gray-400">Bet: <span id="g-bet">0</span></div></div>
        </div>
        
        <div class="flex-1 flex flex-col items-center justify-center p-4">
            <div id="g-waiting" class="text-center">
                <div class="text-5xl mb-4 animate-bounce">⏳</div>
                <h3 class="text-xl font-bold">รอผู้เล่น...</h3>
                <p class="text-gray-500 text-sm mt-2">รหัสห้อง: <span id="g-pass" class="font-mono bg-gray-100 px-2 rounded font-bold text-black select-all"></span></p>
            </div>

            <div id="g-playing" class="hidden w-full max-w-lg">
                <div class="flex justify-between mb-8 bg-black text-white p-4 rounded-xl">
                    <div class="text-center w-1/3"><div class="text-xs text-gray-400">YOU</div><div id="p1-score" class="text-3xl font-bold">0</div></div>
                    <div class="font-bold text-gray-500 pt-2">VS</div>
                    <div class="text-center w-1/3"><div class="text-xs text-gray-400">OPPONENT</div><div id="p2-score" class="text-3xl font-bold">0</div></div>
                </div>

                <div id="area-xo" class="hidden grid grid-cols-3 gap-2 max-w-[300px] mx-auto"></div>

                <div id="area-rps" class="hidden text-center">
                    <div class="flex justify-center gap-4 mb-4">
                        <div onclick="Game.moveRPS('rock')" id="btn-rock" class="rps-btn"><i class="fa-regular fa-hand-back-fist"></i></div>
                        <div onclick="Game.moveRPS('paper')" id="btn-paper" class="rps-btn"><i class="fa-regular fa-hand"></i></div>
                        <div onclick="Game.moveRPS('scissors')" id="btn-scissors" class="rps-btn"><i class="fa-regular fa-hand-scissors"></i></div>
                    </div>
                    <div id="rps-status" class="font-bold text-xl mb-2">เลือกเลย!</div>
                    
                    <div class="timer-wrap" id="rps-timer-wrap">
                        <div class="timer-bar" id="rps-timer-bar"></div>
                    </div>
                    <div id="rps-timer-text" class="text-red-500 font-bold mt-1 h-6"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAHAkBhypqyJuuL22tLrFKN7ZqdEsqGDTk",
            authDomain: "rsdm-9ca2a.firebaseapp.com",
            projectId: "rsdm-9ca2a",
            storageBucket: "rsdm-9ca2a.firebasestorage.app",
            messagingSenderId: "299212700124",
            appId: "1:299212700124:web:730160dae6bb1b09cbb719"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let user = null, userData = null, currentRoomId = null, unsubRoom = null, rpsTimer = null;

        const UI = {
            toggleAuth: (mode) => {
                document.getElementById('login-form').style.display = mode === 'reg' ? 'none' : 'block';
                document.getElementById('reg-form').style.display = mode === 'reg' ? 'block' : 'none';
            },
            showApp: () => {
                document.getElementById('auth-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
            },
            loadConfig: () => {
                db.collection('config').doc('settings').onSnapshot(doc => {
                    const d = doc.data() || {};
                    if(d.isOpen === false) {
                        document.getElementById('maintenance-view').classList.remove('hidden');
                    } else {
                        document.getElementById('maintenance-view').classList.add('hidden');
                    }
                    
                    const name = d.siteName || 'GAME ZONE.';
                    document.getElementById('site-name-auth').innerText = name;
                    document.getElementById('site-name-nav').innerText = name;
                    document.getElementById('site-rules').innerText = d.rules || 'ไม่มีกติกาพิเศษ';
                    document.getElementById('btn-contact').href = d.fbLink || '#';
                });
            }
        };

        const Auth = {
            login: () => {
                const e = document.getElementById('l-email').value;
                const p = document.getElementById('l-pass').value;
                auth.signInWithEmailAndPassword(e, p).catch(e => Swal.fire('Error', e.message, 'error'));
            },
            register: () => {
                const n = document.getElementById('r-name').value;
                const e = document.getElementById('r-email').value;
                const p = document.getElementById('r-pass').value;
                if(!n || !e || !p) return Swal.fire('!', 'กรอกให้ครบ', 'warning');
                auth.createUserWithEmailAndPassword(e, p).then(cred => {
                    db.collection('users').doc(cred.user.uid).set({ nickname: n, email: e, uid: cred.user.uid, credit: 0 });
                    Swal.fire('Success', 'สมัครสำเร็จ', 'success');
                }).catch(e => Swal.fire('Error', e.message, 'error'));
            },
            logout: () => auth.signOut()
        };

        const Game = {
            loadLobby: () => {
                db.collection('rooms').onSnapshot(snap => {
                    const list = document.getElementById('room-list');
                    if(snap.empty) { list.innerHTML = '<div class="col-span-full text-center text-gray-400">ไม่มีห้อง</div>'; return; }
                    
                    let rooms = [];
                    snap.forEach(doc => rooms.push({id: doc.id, ...doc.data()}));
                    rooms.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));

                    list.innerHTML = rooms.map(r => `
                        <div onclick="Game.join('${r.id}', ${r.betAmount}, '${r.password}')" class="bg-white p-6 rounded-xl border hover:border-black cursor-pointer transition shadow-sm">
                            <div class="flex justify-between mb-2">
                                <div class="font-bold text-lg">${r.roomName}</div>
                                <div class="font-bold">฿${r.betAmount}</div>
                            </div>
                            <div class="flex justify-between text-xs font-bold text-gray-400 uppercase">
                                <span>${r.gameType.toUpperCase()}</span>
                                <span class="${r.players.length>=2?'text-red-500':'text-green-500'}">${r.players.length}/2</span>
                            </div>
                        </div>`).join('');
                });
            },
            join: async (id, bet, realPass) => {
                if(userData.credit < bet) return Swal.fire('!', 'เครดิตไม่พอ', 'error');
                const { value: pass } = await Swal.fire({ title: 'ใส่รหัสห้อง', input: 'text', showCancelButton: true });
                if(pass !== realPass) return Swal.fire('!', 'รหัสผิด', 'error');

                const ref = db.collection('rooms').doc(id);
                const r = (await ref.get()).data();
                if(!r.players.includes(user.uid)) {
                    if(r.players.length >= 2) return Swal.fire('!', 'ห้องเต็ม', 'error');
                    await ref.update({ players: firebase.firestore.FieldValue.arrayUnion(user.uid) });
                }
                Game.enterRoom(id, r.gameType);
            },
            enterRoom: (id, type) => {
                currentRoomId = id;
                document.getElementById('game-view').classList.remove('hidden');
                document.getElementById('area-xo').classList.add('hidden');
                document.getElementById('area-rps').classList.add('hidden');
                document.getElementById(`area-${type}`).classList.remove('hidden');

                unsubRoom = db.collection('rooms').doc(id).onSnapshot(snap => {
                    if(!snap.exists) { Game.leave(); return; }
                    const r = snap.data();
                    
                    document.getElementById('g-name').innerText = r.roomName;
                    document.getElementById('g-bet').innerText = r.betAmount;
                    document.getElementById('g-pass').innerText = r.password;

                    if(r.players.length < 2) {
                        document.getElementById('g-waiting').classList.remove('hidden');
                        document.getElementById('g-playing').classList.add('hidden');
                    } else {
                        document.getElementById('g-waiting').classList.add('hidden');
                        document.getElementById('g-playing').classList.remove('hidden');
                    }

                    // Scores
                    const p1 = r.players[0];
                    const p2 = r.players[1];
                    const myIdx = user.uid === p1 ? 0 : 1;
                    document.getElementById('p1-score').innerText = myIdx===0 ? (r.scores[p1]||0) : (r.scores[p2]||0);
                    document.getElementById('p2-score').innerText = myIdx===0 ? (r.scores[p2]||0) : (r.scores[p1]||0);

                    // Win Check
                    const sc1 = r.scores[p1]||0; const sc2 = r.scores[p2]||0;
                    if(sc1 >= r.maxWins || sc2 >= r.maxWins) {
                        const win = sc1 > sc2 ? p1 : p2;
                        Swal.fire({
                            title: win===user.uid ? 'YOU WIN!' : 'YOU LOSE!',
                            icon: win===user.uid ? 'success':'error'
                        }).then(() => {
                            if(win===user.uid) {
                                db.collection('users').doc(p1).update({credit: firebase.firestore.FieldValue.increment(win===p1 ? r.betAmount : -r.betAmount)});
                                db.collection('users').doc(p2).update({credit: firebase.firestore.FieldValue.increment(win===p2 ? r.betAmount : -r.betAmount)});
                                db.collection('rooms').doc(id).delete();
                            }
                            Game.leave();
                        });
                        return;
                    }

                    // Game Specific
                    if(type === 'xo') Game.renderXO(r);
                    if(type === 'rps') Game.renderRPS(r);
                });
            },
            leave: () => {
                if(unsubRoom) unsubRoom();
                document.getElementById('game-view').classList.add('hidden');
                currentRoomId = null;
                clearInterval(rpsTimer);
            },
            
            // --- XO Logic ---
            renderXO: (r) => {
                const b = document.getElementById('area-xo');
                b.innerHTML = '';
                r.board.forEach((c, i) => {
                    const el = document.createElement('div');
                    el.className = `xo-cell ${c||''}`;
                    el.innerText = c || '';
                    el.onclick = () => {
                        if(c || r.currentTurn && r.currentTurn !== user.uid) return;
                        if(!r.currentTurn && user.uid !== r.players[0]) return; // P1 starts
                        
                        const sym = user.uid === r.players[0] ? 'X' : 'O';
                        let nb = [...r.board]; nb[i] = sym;
                        
                        // Simple win check
                        const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
                        const isWin = wins.some(w => w.every(x => nb[x] === sym));
                        
                        let upd = { board: nb, currentTurn: r.players.find(x => x!==user.uid) };
                        if(isWin) {
                            upd[`scores.${user.uid}`] = firebase.firestore.FieldValue.increment(1);
                            upd.board = Array(9).fill(null);
                        } else if(!nb.includes(null)) {
                            upd.board = Array(9).fill(null); // Draw
                        }
                        db.collection('rooms').doc(currentRoomId).update(upd);
                    };
                    b.appendChild(el);
                });
            },

            // --- RPS Logic with 5s Timer ---
            renderRPS: (r) => {
                const myMove = r.moves ? r.moves[user.uid] : null;
                const status = document.getElementById('rps-status');
                
                ['rock','paper','scissors'].forEach(m => {
                    const btn = document.getElementById(`btn-${m}`);
                    btn.classList.remove('selected');
                    if(myMove === m) btn.classList.add('selected');
                });

                if(!myMove) {
                    status.innerText = "เลือกภายใน 5 วินาที!";
                    // Start Timer logic if not already moved
                    if(r.roundState === 'idle') {
                        // Start round logic (Usually 1 person triggers status change to 'selecting')
                        if(user.uid === r.players[0]) db.collection('rooms').doc(currentRoomId).update({ roundState: 'selecting', roundStart: Date.now() });
                    }
                    if(r.roundState === 'selecting') {
                        Game.startRPSTimer();
                    }
                } else {
                    status.innerText = "รอผล...";
                    document.getElementById('rps-timer-wrap').style.display = 'none';
                }

                // Check Result
                if(r.players[0] === user.uid && r.moves && Object.keys(r.moves).length === 2) {
                    const p1 = r.players[0]; const p2 = r.players[1];
                    const m1 = r.moves[p1]; const m2 = r.moves[p2];
                    let winner = null;
                    if(m1!==m2) {
                        if((m1==='rock'&&m2==='scissors')||(m1==='paper'&&m2==='rock')||(m1==='scissors'&&m2==='paper')) winner = p1;
                        else winner = p2;
                    }
                    setTimeout(() => {
                        let up = { moves: {}, roundState: 'idle' };
                        if(winner) up[`scores.${winner}`] = firebase.firestore.FieldValue.increment(1);
                        db.collection('rooms').doc(currentRoomId).update(up);
                        Swal.fire({ title: winner===user.uid?'WIN':'LOSE', timer:1000, showConfirmButton:false });
                    }, 1000);
                }
            },
            startRPSTimer: () => {
                const bar = document.getElementById('rps-timer-bar');
                const wrap = document.getElementById('rps-timer-wrap');
                const txt = document.getElementById('rps-timer-text');
                
                wrap.style.display = 'block';
                let left = 5;
                bar.style.width = '100%';
                
                clearInterval(rpsTimer);
                rpsTimer = setInterval(() => {
                    left--;
                    txt.innerText = left;
                    bar.style.width = (left/5)*100 + '%';
                    
                    if(left <= 0) {
                        clearInterval(rpsTimer);
                        // Auto pick random
                        const moves = ['rock','paper','scissors'];
                        const rand = moves[Math.floor(Math.random()*3)];
                        Game.moveRPS(rand);
                    }
                }, 1000);
            },
            moveRPS: (m) => {
                clearInterval(rpsTimer);
                db.collection('rooms').doc(currentRoomId).update({ [`moves.${user.uid}`]: m });
            }
        };

        // Init
        UI.loadConfig();
        auth.onAuthStateChanged(u => {
            if(u) {
                user = u;
                db.collection('users').doc(u.uid).onSnapshot(doc => {
                    userData = doc.data();
                    document.getElementById('u-name').innerText = userData.nickname;
                    document.getElementById('u-credit').innerText = userData.credit;
                });
                UI.showApp();
            } else {
                document.getElementById('auth-view').classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
